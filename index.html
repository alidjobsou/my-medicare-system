<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medicare Management System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--primary:#6366f1;--secondary:#8b5cf6;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--info:#3b82f6;--bg-primary:#fff;--bg-secondary:#f8fafc;--text-primary:#1e293b;--text-secondary:#64748b;--border:#e2e8f0;--shadow:rgba(0,0,0,0.1)}
[data-theme="dark"]{--primary:#818cf8;--secondary:#a78bfa;--bg-primary:#0f172a;--bg-secondary:#1e293b;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#334155;--shadow:rgba(0,0,0,0.3)}
*{margin:0;padding:0;box-sizing:border-box;transition:background .3s,color .3s,border .3s}
body{font-family:'Inter',sans-serif;background:var(--bg-secondary);color:var(--text-primary)}
.login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary),var(--secondary));padding:20px;position:relative;overflow:hidden}
.login-container::before{content:'';position:absolute;width:500px;height:500px;background:rgba(255,255,255,0.1);border-radius:50%;top:-250px;right:-250px;animation:float 6s ease-in-out infinite}
.login-container::after{content:'';position:absolute;width:400px;height:400px;background:rgba(255,255,255,0.1);border-radius:50%;bottom:-200px;left:-200px;animation:float 8s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
.login-box{background:var(--bg-primary);border-radius:24px;box-shadow:0 25px 50px var(--shadow);overflow:hidden;max-width:1100px;width:100%;display:grid;grid-template-columns:1fr 1fr;position:relative;z-index:1}
.login-left{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:60px 50px;display:flex;flex-direction:column;justify-content:center;position:relative;overflow:hidden}
.login-left::before{content:'';position:absolute;width:300px;height:300px;background:rgba(255,255,255,0.1);border-radius:50%;top:-100px;right:-100px}
.login-left h1{font-size:2.8em;margin-bottom:20px;font-weight:700;position:relative}
.login-left p{font-size:1.15em;opacity:.95;line-height:1.7;margin-bottom:40px;position:relative}
.login-left .features{position:relative}
.login-left .feature-item{display:flex;align-items:center;gap:15px;margin-bottom:20px;padding:15px;background:rgba(255,255,255,0.1);border-radius:12px;backdrop-filter:blur(10px)}
.login-left .feature-item i{font-size:1.5em;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.2);border-radius:10px}
.login-right{padding:60px 50px;background:var(--bg-primary)}
.login-right h2{color:var(--text-primary);margin-bottom:10px;font-size:2.2em;font-weight:700}
.login-right p{color:var(--text-secondary);margin-bottom:35px;font-size:1.05em}
.form-group{margin-bottom:24px}
.form-group label{display:block;margin-bottom:10px;font-weight:600;color:var(--text-primary);font-size:.95em}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:16px;border:2px solid var(--border);border-radius:12px;font-size:15px;background:var(--bg-secondary);color:var(--text-primary)}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,0.1)}
.password-input{position:relative}
.password-toggle{position:absolute;right:16px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--text-secondary)}
.password-toggle:hover{color:var(--primary)}
.btn{padding:12px 24px;border:none;border-radius:10px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-size:.95em;transition:all .3s}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;box-shadow:0 4px 12px rgba(99,102,241,0.3);width:100%}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(99,102,241,0.4)}
.btn-success{background:var(--success);color:#fff}
.btn-success:hover{background:#059669;transform:translateY(-2px)}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{background:#dc2626;transform:translateY(-2px)}
.btn-warning{background:var(--warning);color:#fff}
.btn-warning:hover{background:#d97706;transform:translateY(-2px)}
.btn-info{background:var(--info);color:#fff}
.btn-info:hover{background:#2563eb;transform:translateY(-2px)}
.btn-secondary{background:var(--text-secondary);color:#fff}
.btn-secondary:hover{background:#475569;transform:translateY(-2px)}
.btn-sm{padding:8px 16px;font-size:.9em}
#mainApp{display:none}
.sidebar{width:280px;height:100vh;background:var(--bg-primary);position:fixed;left:0;top:0;padding:0;overflow-y:auto;box-shadow:4px 0 20px var(--shadow);z-index:1000;border-right:1px solid var(--border)}
.sidebar-header{padding:30px 25px;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff}
.sidebar-header h2{font-size:1.6em;margin-bottom:8px;font-weight:700}
.sidebar-header p{font-size:.9em;opacity:.95}
.sidebar-menu{list-style:none;padding:25px 15px}
.sidebar-menu li{padding:16px 20px;margin:6px 0;cursor:pointer;border-radius:12px;transition:all .3s;display:flex;align-items:center;gap:14px;color:var(--text-secondary);font-weight:500;position:relative}
.sidebar-menu li:hover{background:var(--bg-secondary);color:var(--primary);transform:translateX(5px)}
.sidebar-menu li.active{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;box-shadow:0 4px 12px rgba(99,102,241,0.3)}
.sidebar-menu li i{width:22px;text-align:center;font-size:1.1em}
.notification-badge{position:absolute;top:10px;right:10px;background:var(--danger);color:#fff;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:.75em;font-weight:700;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.main-content{margin-left:280px;padding:30px;min-height:100vh}
.top-bar{background:var(--bg-primary);padding:24px 32px;border-radius:16px;margin-bottom:30px;box-shadow:0 2px 12px var(--shadow);display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border)}
.top-bar h1{font-size:1.9em;color:var(--text-primary);font-weight:700}
.top-bar-right{display:flex;align-items:center;gap:20px}
.theme-toggle{width:50px;height:50px;border-radius:12px;background:var(--bg-secondary);border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2em;color:var(--text-primary);transition:all .3s}
.theme-toggle:hover{background:var(--primary);color:#fff;border-color:var(--primary);transform:rotate(180deg)}
.notification-bell{width:50px;height:50px;border-radius:12px;background:var(--bg-secondary);border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2em;color:var(--text-primary);transition:all .3s;position:relative}
.notification-bell:hover{background:var(--primary);color:#fff;border-color:var(--primary)}
.notification-bell .badge{position:absolute;top:-5px;right:-5px;background:var(--danger);color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:.7em;font-weight:700}
.user-avatar{width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.1em;cursor:pointer;transition:all .3s}
.user-avatar:hover{transform:scale(1.05);box-shadow:0 4px 12px rgba(99,102,241,0.3)}
.user-dropdown{position:relative}
.user-menu{position:absolute;top:110%;right:0;background:var(--bg-primary);border-radius:12px;box-shadow:0 8px 24px var(--shadow);padding:12px 0;min-width:220px;display:none;z-index:1000;border:1px solid var(--border)}
.user-menu.show{display:block;animation:slideDown .3s ease}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.user-menu a{display:flex;align-items:center;gap:12px;padding:14px 20px;color:var(--text-primary);text-decoration:none;transition:all .3s}
.user-menu a:hover{background:var(--bg-secondary);color:var(--primary)}
.user-menu a i{width:20px;text-align:center}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:25px;margin-bottom:30px}
.stat-card{background:var(--bg-primary);padding:28px;border-radius:16px;box-shadow:0 2px 12px var(--shadow);position:relative;overflow:hidden;border:1px solid var(--border);transition:all .3s}
.stat-card:hover{transform:translateY(-5px);box-shadow:0 8px 24px var(--shadow)}
.stat-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:linear-gradient(135deg,var(--primary),var(--secondary))}
.stat-card h3{font-size:2.6em;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px;font-weight:700}
.stat-card p{color:var(--text-secondary);font-size:1em;font-weight:500}
.stat-card i{position:absolute;right:25px;top:25px;font-size:2.8em;opacity:.08;color:var(--primary)}
.card{background:var(--bg-primary);padding:32px;border-radius:16px;margin-bottom:25px;box-shadow:0 2px 12px var(--shadow);border:1px solid var(--border)}
.card h2{color:var(--text-primary);margin-bottom:24px;font-size:1.6em;font-weight:700}
.card h3{color:var(--text-primary);margin-bottom:15px;font-size:1.3em;font-weight:600}
.data-table{width:100%;border-collapse:collapse;margin-top:20px}
.data-table thead{background:var(--bg-secondary)}
.data-table th,.data-table td{padding:16px;text-align:left;border-bottom:1px solid var(--border);color:var(--text-primary)}
.data-table th{font-weight:600;font-size:.95em;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary)}
.data-table tbody tr{transition:all .3s}
.data-table tbody tr:hover{background:var(--bg-secondary)}
.badge{padding:6px 14px;border-radius:20px;font-size:.85em;font-weight:600;display:inline-block}
.badge-success{background:rgba(16,185,129,0.15);color:var(--success)}
.badge-warning{background:rgba(245,158,11,0.15);color:var(--warning)}
.badge-danger{background:rgba(239,68,68,0.15);color:var(--danger)}
.badge-info{background:rgba(59,130,246,0.15);color:var(--info)}
.badge-primary{background:rgba(99,102,241,0.15);color:var(--primary)}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:2000;align-items:center;justify-content:center}
.modal.show{display:flex;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-content{background:var(--bg-primary);padding:35px;border-radius:20px;max-width:650px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px var(--shadow);border:1px solid var(--border);animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid var(--border)}
.modal-header h3{background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:1.6em;font-weight:700}
.close-modal{background:var(--bg-secondary);border:none;width:40px;height:40px;border-radius:10px;font-size:1.3em;cursor:pointer;color:var(--text-secondary);transition:all .3s}
.close-modal:hover{background:var(--danger);color:#fff;transform:rotate(90deg)}
.section{display:none}
.section.active{display:block;animation:fadeInUp .4s ease}
@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.alert{padding:16px 20px;border-radius:12px;margin-bottom:20px;display:none;font-weight:500;border:1px solid}
.alert.show{display:block;animation:slideDown .3s ease}
.alert-success{background:rgba(16,185,129,0.15);color:var(--success);border-color:var(--success)}
.alert-danger{background:rgba(239,68,68,0.15);color:var(--danger);border-color:var(--danger)}
.alert-warning{background:rgba(245,158,11,0.15);color:var(--warning);border-color:var(--warning)}
.task-card{background:var(--bg-secondary);padding:24px;border-radius:12px;margin-bottom:20px;border:1px solid var(--border);transition:all .3s}
.task-card:hover{box-shadow:0 4px 12px var(--shadow);transform:translateY(-2px)}
.task-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid var(--border)}
.task-header h4{color:var(--text-primary);font-weight:600}
.task-body{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
.task-item{display:flex;flex-direction:column;gap:6px}
.task-item label{font-size:.85em;color:var(--text-secondary);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.task-item span{color:var(--text-primary);font-weight:500}
.notification-toast{position:fixed;top:20px;right:20px;background:var(--bg-primary);padding:18px 24px;border-radius:12px;box-shadow:0 8px 24px var(--shadow);border-left:4px solid var(--success);z-index:3000;display:none;min-width:300px;max-width:400px}
.notification-toast.show{display:block;animation:slideInRight .3s ease}
@keyframes slideInRight{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
.notification-toast.hide{animation:slideOutRight .3s ease}
@keyframes slideOutRight{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}
.notification-toast h4{margin-bottom:8px;font-size:1.1em;color:var(--text-primary)}
.notification-toast p{margin:0;color:var(--text-secondary);font-size:.9em}
.message-card{background:var(--bg-primary);padding:20px;border-radius:12px;margin-bottom:15px;border-left:4px solid var(--primary);box-shadow:0 2px 8px var(--shadow);cursor:pointer}
.message-card.unread{background:rgba(99,102,241,0.05);border-left-color:var(--warning)}
.message-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.message-from{font-weight:600;color:var(--primary);font-size:1.05em}
.message-time{font-size:.8em;color:var(--text-secondary)}
.message-content{color:var(--text-primary);line-height:1.6;margin-bottom:10px}
.message-patient{font-size:.85em;color:var(--text-secondary);font-style:italic}
.role-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:.8em;font-weight:600;margin-left:10px}
.role-admin{background:rgba(239,68,68,0.15);color:var(--danger)}
.role-doctor{background:rgba(99,102,241,0.15);color:var(--primary)}
.role-nurse{background:rgba(16,185,129,0.15);color:var(--success)}
.role-receptionist{background:rgba(245,158,11,0.15);color:var(--warning)}
.role-pharmacy{background:rgba(59,130,246,0.15);color:var(--info)}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}
textarea{resize:vertical;font-family:inherit}
.switch-account-btn{margin-top:20px;text-align:center}
.switch-account-btn a{color:var(--primary);text-decoration:none;font-weight:600;transition:color .3s}
.switch-account-btn a:hover{color:var(--secondary)}
.prescription-card{background:linear-gradient(135deg,rgba(99,102,241,0.05),rgba(139,92,246,0.05));padding:24px;border-radius:12px;margin-bottom:20px;border:2px solid var(--border);position:relative;overflow:hidden}
.prescription-card::before{content:'℞';position:absolute;right:20px;top:20px;font-size:4em;opacity:.05;font-weight:bold}
.prescription-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:20px}
.prescription-header h4{color:var(--primary);font-weight:700;font-size:1.3em}
.prescription-body{display:grid;gap:16px}
.prescription-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-primary);border-radius:8px}
.prescription-item i{color:var(--primary);font-size:1.2em}
.prescription-item-content{flex:1}
.prescription-item-content strong{color:var(--text-primary);display:block;margin-bottom:4px}
.prescription-item-content span{color:var(--text-secondary);font-size:.9em}
.payment-card{background:linear-gradient(135deg,rgba(16,185,129,0.05),rgba(59,130,246,0.05));padding:24px;border-radius:12px;margin-bottom:20px;border:2px solid var(--success);position:relative}
.payment-card h4{color:var(--success);font-weight:700;margin-bottom:15px}
.payment-details{display:grid;gap:12px}
.payment-row{display:flex;justify-content:space-between;padding:10px;background:var(--bg-primary);border-radius:8px}
.payment-row strong{color:var(--text-primary)}
.payment-row span{color:var(--text-secondary)}
.payment-total{font-size:1.3em;color:var(--success);font-weight:700;margin-top:10px;padding-top:10px;border-top:2px solid var(--border)}
.archive-card{background:var(--bg-secondary);padding:20px;border-radius:12px;margin-bottom:15px;border-left:4px solid var(--info);opacity:0.9}
.archive-card:hover{opacity:1;box-shadow:0 4px 12px var(--shadow)}
.db-tabs{display:flex;gap:10px;margin-bottom:25px;flex-wrap:wrap;border-bottom:2px solid var(--border);padding-bottom:10px}
.db-tab{padding:12px 20px;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;color:var(--text-secondary);transition:all .3s;border-bottom:none;margin-bottom:-2px}
.db-tab:hover{background:var(--bg-primary);color:var(--primary)}
.db-tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.db-diagram{background:var(--bg-secondary);padding:30px;border-radius:12px;overflow-x:auto}
.db-table-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px}
.db-table-card{background:var(--bg-secondary);border-radius:12px;padding:20px;border:2px solid var(--border)}
.db-table-card h3{color:var(--primary);margin-bottom:15px;font-size:1.2em;display:flex;align-items:center;gap:10px}
.db-table-card .record-count{background:var(--primary);color:#fff;padding:4px 12px;border-radius:20px;font-size:.85em}
.db-field{padding:8px 12px;background:var(--bg-primary);margin:5px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:center;font-size:.9em}
.db-field-name{font-weight:600;color:var(--text-primary)}
.db-field-type{color:var(--text-secondary);font-size:.85em;font-family:monospace}
.db-field.primary-key{border-left:4px solid var(--warning)}
.db-field.foreign-key{border-left:4px solid var(--info)}
.relationship-diagram{background:var(--bg-secondary);padding:30px;border-radius:12px;overflow-x:auto}
.relationship-card{background:var(--bg-primary);padding:20px;border-radius:12px;margin:15px 0;border-left:4px solid var(--primary)}
.relationship-card h4{color:var(--primary);margin-bottom:10px}
.flow-step{background:var(--bg-secondary);padding:20px;border-radius:12px;margin:15px 0;border-left:4px solid var(--success)}
.flow-step h4{color:var(--success);margin-bottom:10px;display:flex;align-items:center;gap:10px}
.flow-step code{background:var(--bg-primary);padding:15px;border-radius:8px;display:block;margin:10px 0;overflow-x:auto;font-size:.9em;color:var(--text-primary)}
.query-console{background:var(--bg-secondary);padding:20px;border-radius:12px}
.query-input{width:100%;min-height:150px;background:var(--bg-primary);border:2px solid var(--border);border-radius:8px;padding:15px;font-family:monospace;color:var(--text-primary);font-size:.95em;margin-bottom:15px}
.query-result{background:var(--bg-primary);padding:20px;border-radius:8px;margin-top:15px;max-height:400px;overflow:auto}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:20px}
.stat-box{background:var(--bg-secondary);padding:20px;border-radius:12px;text-align:center;border:2px solid var(--border)}
.stat-box h3{font-size:2.5em;color:var(--primary);margin-bottom:5px}
.stat-box p{color:var(--text-secondary);font-size:.9em}
.er-diagram{font-family:monospace;font-size:.85em;line-height:1.6;white-space:pre;color:var(--text-primary)}
.data-table-viewer{width:100%;max-height:500px;overflow:auto;margin-top:15px}
.data-table-viewer table{width:100%;border-collapse:collapse}
.data-table-viewer th{background:var(--primary);color:#fff;padding:12px;text-align:left;position:sticky;top:0;z-index:10}
.data-table-viewer td{padding:10px 12px;border-bottom:1px solid var(--border);color:var(--text-primary)}
.data-table-viewer tr:hover{background:var(--bg-secondary)}
.json-viewer{background:var(--bg-primary);padding:15px;border-radius:8px;overflow-x:auto}
.json-viewer pre{margin:0;color:var(--text-primary);font-size:.9em}
@media (max-width:968px){.login-box{grid-template-columns:1fr}.login-left{display:none}.sidebar{width:70px}.sidebar-header h2,.sidebar-header p,.sidebar-menu li span{display:none}.main-content{margin-left:70px;padding:15px}.stats-grid{grid-template-columns:1fr}.top-bar{flex-direction:column;gap:15px}}
::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-track{background:var(--bg-secondary)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:5px}
::-webkit-scrollbar-thumb:hover{background:var(--primary)}
</style>
</head>
<body>
<div id="loginPage" class="login-container">
<div class="login-box">
<div class="login-left">
<h1><i class="fas fa-hospital-alt"></i> Medicare</h1>
<p>Advanced Healthcare Management System with comprehensive patient care, medical records, and prescription management.</p>
<div class="features">
<div class="feature-item"><i class="fas fa-user-md"></i><span>Complete Patient Management</span></div>
<div class="feature-item"><i class="fas fa-file-medical-alt"></i><span>Digital Medical Records</span></div>
<div class="feature-item"><i class="fas fa-prescription-bottle-alt"></i><span>E-Prescription System</span></div>
<div class="feature-item"><i class="fas fa-pills"></i><span>Pharmacy Integration</span></div>
<div class="feature-item"><i class="fas fa-comments"></i><span>Real-Time Messaging</span></div>
</div>
</div>
<div class="login-right">
<h2>Welcome Back!</h2>
<p>Please login to your account</p>
<form id="loginForm" onsubmit="handleLogin(event)">
<div class="form-group">
<label><i class="fas fa-envelope"></i> Email Address</label>
<input type="email" id="loginEmail" placeholder="Enter your email" required>
</div>
<div class="form-group">
<label><i class="fas fa-lock"></i> Password</label>
<div class="password-input">
<input type="password" id="loginPassword" placeholder="Enter your password" required>
<i class="fas fa-eye password-toggle" onclick="togglePassword('loginPassword')"></i>
</div>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Login to Dashboard</button>
<div class="switch-account-btn">
<a href="#" onclick="openModal('switchAccountModal')"><i class="fas fa-exchange-alt"></i> Switch Account</a>
</div>
</form>
</div>
</div>
</div>

<div id="mainApp">
<div class="sidebar">
<div class="sidebar-header">
<h2><i class="fas fa-hospital-alt"></i> Medicare</h2>
<p>Management System</p>
</div>
<ul class="sidebar-menu" id="sidebarMenu"></ul>
</div>

<div class="main-content">
<div class="top-bar">
<div>
<h1 id="pageTitle">Dashboard</h1>
<p style="color:var(--text-secondary);margin-top:5px;">Welcome back, <span id="userName">User</span><span id="userRoleBadge"></span></p>
</div>
<div class="top-bar-right">
<button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode"><i class="fas fa-moon" id="themeIcon"></i></button>
<button class="notification-bell" onclick="showSection('messages')" title="Messages">
<i class="fas fa-envelope"></i>
<span class="badge" id="messageCount" style="display:none;">0</span>
</button>
<button class="btn btn-primary btn-sm" onclick="openModal('switchAccountModal')"><i class="fas fa-exchange-alt"></i> Switch</button>
<div class="user-dropdown">
<div class="user-avatar" onclick="toggleUserMenu()"><span id="userInitials">AD</span></div>
<div class="user-menu" id="userMenu">
<a href="#" onclick="showSection('settings')"><i class="fas fa-user"></i> Profile</a>
<a href="#" onclick="showSection('messages')"><i class="fas fa-envelope"></i> Messages</a>
<a href="#" onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</a>
<a href="#" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
</div>
</div>
</div>
</div>

<div id="alert" class="alert"></div>
<div id="notificationToast" class="notification-toast"></div>

<div id="dashboard" class="section active">
<div class="stats-grid">
<div class="stat-card"><i class="fas fa-users"></i><h3 id="totalPatients">0</h3><p>Total Patients</p></div>
<div class="stat-card"><i class="fas fa-calendar-check"></i><h3 id="activeAppointments">0</h3><p>Active Appointments</p></div>
<div class="stat-card"><i class="fas fa-tasks"></i><h3 id="pendingTasks">0</h3><p>Pending Tasks</p></div>
<div class="stat-card"><i class="fas fa-dollar-sign"></i><h3 id="totalRevenue">$0</h3><p>Total Revenue</p></div>
</div>
<div class="card">
<h2><i class="fas fa-bell"></i> Active Appointments</h2>
<div id="activeAppointmentsList"></div>
</div>
</div>

<div id="messages" class="section">
<div class="card">
<h2><i class="fas fa-envelope"></i> Messages & Notifications</h2>
<div id="messagesList"></div>
</div>
</div>

<div id="reception" class="section">
<div class="card">
<h2><i class="fas fa-desk"></i> Reception Desk</h2>
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;">
<button class="btn btn-primary" onclick="openModal('addPatientModal')"><i class="fas fa-user-plus"></i> Register Patient</button>
<button class="btn btn-primary" onclick="openModal('scheduleModal')"><i class="fas fa-calendar-plus"></i> Schedule Appointment</button>
<button class="btn btn-success" onclick="openModal('checkInModal')"><i class="fas fa-sign-in-alt"></i> Check-In</button>
<button class="btn btn-danger" onclick="openModal('checkOutModal')"><i class="fas fa-sign-out-alt"></i> Check-Out</button>
<button class="btn btn-info" onclick="debugAppointments()"><i class="fas fa-bug"></i> Debug Status</button>
</div>
<h3 style="margin-top:25px;margin-bottom:15px;">Pending Payments</h3>
<div id="pendingPayments"></div>
<h3 style="margin-top:25px;margin-bottom:15px;">All Appointments</h3>
<div id="allAppointments"></div>
</div>
</div>

<div id="nursing" class="section">
<div class="card">
<h2><i class="fas fa-heartbeat"></i> Nursing Station</h2>
<button class="btn btn-primary" onclick="openModal('vitalsModal')"><i class="fas fa-notes-medical"></i> Record Vitals</button>
<button class="btn btn-primary" onclick="openModal('historyModal')" style="margin-left:10px;"><i class="fas fa-history"></i> Update History</button>
<h3 style="margin-top:25px;margin-bottom:15px;">Patients Ready for Vitals</h3>
<div id="patientsForVitals"></div>
</div>
</div>

<div id="clinical" class="section">
<div class="card">
<h2><i class="fas fa-stethoscope"></i> Clinical Workspace</h2>
<button class="btn btn-primary" onclick="openModal('examModal')"><i class="fas fa-file-medical"></i> Document Exam</button>
<button class="btn btn-primary" onclick="openModal('prescriptionModal')" style="margin-left:10px;"><i class="fas fa-prescription"></i> E-Prescribe</button>
<button class="btn btn-success" onclick="openModal('labOrderModal')" style="margin-left:10px;"><i class="fas fa-flask"></i> Order Lab</button>
<h3 style="margin-top:25px;margin-bottom:15px;">Patients Ready for Consultation</h3>
<div id="patientsForDoctor"></div>
</div>
</div>

<div id="pharmacy" class="section">
<div class="card">
<h2><i class="fas fa-pills"></i> Pharmacy Management</h2>
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;">
<button class="btn btn-primary" onclick="openModal('inventoryModal')"><i class="fas fa-boxes"></i> Manage Inventory</button>
<button class="btn btn-success" onclick="openModal('dispenseMedModal')"><i class="fas fa-hand-holding-medical"></i> Dispense Medication</button>
<button class="btn btn-warning" onclick="openModal('refillModal')"><i class="fas fa-redo"></i> Process Refill</button>
</div>
<h3 style="margin-top:25px;margin-bottom:15px;">Pending Prescriptions</h3>
<div id="pendingPrescriptions"></div>
<h3 style="margin-top:25px;margin-bottom:15px;">Dispensed Medications</h3>
<div id="dispensedMedications"></div>
</div>
</div>

<div id="billing" class="section">
<div class="card">
<h2><i class="fas fa-file-invoice-dollar"></i> Billing & Claims</h2>
<button class="btn btn-primary" onclick="openModal('copayModal')"><i class="fas fa-dollar-sign"></i> Collect Copay</button>
<button class="btn btn-success" onclick="openModal('claimModal')" style="margin-left:10px;"><i class="fas fa-file-invoice"></i> Submit Claim</button>
<h3 style="margin-top:25px;margin-bottom:15px;">Pending Billing</h3>
<div id="pendingBilling"></div>
</div>
</div>

<div id="patients" class="section">
<div class="card">
<h2><i class="fas fa-users"></i> Patient Registry</h2>
<table class="data-table">
<thead><tr><th>ID</th><th>Name</th><th>DOB</th><th>Medicare ID</th><th>Status</th><th>Actions</th></tr></thead>
<tbody id="patientsList"></tbody>
</table>
</div>
</div>

<div id="archives" class="section">
<div class="card">
<h2><i class="fas fa-archive"></i> Archives</h2>
<p style="color:var(--text-secondary);margin-bottom:20px;">Completed appointments and patient records</p>
<div id="archivesList"></div>
</div>
</div>

<div id="settings" class="section">
<div class="card">
<h2><i class="fas fa-user-circle"></i> User Profile</h2>
<div class="form-row">
<div class="form-group"><label>Full Name</label><input type="text" id="profileName" class="form-control" readonly></div>
<div class="form-group"><label>Email</label><input type="email" id="profileEmail" class="form-control" readonly></div>
</div>
<div class="form-row">
<div class="form-group"><label>Role</label><input type="text" id="profileRole" class="form-control" readonly></div>
</div>
</div>

<div class="card" id="systemManagementCard">
<h2><i class="fas fa-cogs"></i> System Management</h2>
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;">
<button class="btn btn-warning" onclick="clearMessages()"><i class="fas fa-envelope-open"></i> Clear All Messages</button>
<button class="btn btn-warning" onclick="clearArchives()"><i class="fas fa-archive"></i> Clear Archives</button>
<button class="btn btn-danger" onclick="resetSystem()"><i class="fas fa-redo-alt"></i> Reset Entire System</button>
<button class="btn btn-info" onclick="exportData()"><i class="fas fa-download"></i> Export Data</button>
</div>
<div class="alert alert-warning" style="display:block;margin-top:20px;">
<i class="fas fa-exclamation-triangle"></i> <strong>Warning:</strong> System reset will delete all data permanently. Export data before resetting.
</div>
</div>

<div class="card" id="financialManagementCard">
<h2><i class="fas fa-money-bill-wave"></i> Financial Management</h2>
<div class="stats-grid" style="margin-bottom:20px;">
<div class="stat-card">
<i class="fas fa-wallet"></i>
<h3 id="currentBalance">$0</h3>
<p>Current Balance</p>
</div>
<div class="stat-card">
<i class="fas fa-chart-line"></i>
<h3 id="totalCollected">$0</h3>
<p>Total Collected</p>
</div>
</div>
<div style="display:flex;gap:12px;flex-wrap:wrap;">
<button class="btn btn-success" onclick="openModal('withdrawModal')"><i class="fas fa-hand-holding-usd"></i> Withdraw Money</button>
<button class="btn btn-danger" onclick="resetAccount()"><i class="fas fa-redo"></i> Reset Account to $0</button>
</div>
<h3 style="margin-top:25px;margin-bottom:15px;">Transaction History</h3>
<div id="transactionHistory"></div>
</div>

<div class="card" id="userManagementCard">
<h2><i class="fas fa-users-cog"></i> User Management</h2>
<button class="btn btn-primary" onclick="openModal('registerUserModal')"><i class="fas fa-user-plus"></i> Register New User</button>
<table class="data-table" style="margin-top:20px;">
<thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Actions</th></tr></thead>
<tbody id="usersList"></tbody>
</table>
</div>

<div class="card" id="databaseViewerCard" style="display:none;">
<h2><i class="fas fa-database"></i> Database Architecture & Viewer</h2>
<p style="color:var(--text-secondary);margin-bottom:20px;">Complete database schema, relationships, and live data explorer</p>

<div class="db-tabs">
<button class="db-tab active" onclick="showDbTab('diagram')"><i class="fas fa-project-diagram"></i> ER Diagram</button>
<button class="db-tab" onclick="showDbTab('tables')"><i class="fas fa-table"></i> Data Tables</button>
<button class="db-tab" onclick="showDbTab('relationships')"><i class="fas fa-link"></i> Relationships</button>
<button class="db-tab" onclick="showDbTab('flow')"><i class="fas fa-stream"></i> Data Flow</button>
<button class="db-tab" onclick="showDbTab('query')"><i class="fas fa-terminal"></i> Query Console</button>
<button class="db-tab" onclick="showDbTab('stats')"><i class="fas fa-chart-bar"></i> Statistics</button>
</div>

<div id="dbTabContent"></div>
</div>
</div>
</div>
</div>

<!-- MODALS -->
<div id="switchAccountModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-exchange-alt"></i> Switch Account</h3>
<button class="close-modal" onclick="closeModal('switchAccountModal')">&times;</button>
</div>
<form onsubmit="switchAccount(event)">
<div class="form-group">
<label>Select Role *</label>
<select id="switchRole" required>
<option value="">Choose Role</option>
<option value="receptionist">Receptionist</option>
<option value="nurse">Nurse</option>
<option value="doctor">Doctor</option>
<option value="pharmacy">Pharmacy</option>
<option value="admin">Administrator</option>
</select>
</div>
<div class="form-group">
<label>Password *</label>
<div class="password-input">
<input type="password" id="switchPassword" placeholder="Enter password for this role" required>
<i class="fas fa-eye password-toggle" onclick="togglePassword('switchPassword')"></i>
</div>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-exchange-alt"></i> Switch Account</button>
</form>
</div>
</div>

<div id="paymentModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-credit-card"></i> Process Payment</h3>
<button class="close-modal" onclick="closeModal('paymentModal')">&times;</button>
</div>
<form onsubmit="processPayment(event)">
<div id="paymentDetails"></div>
<div class="form-group">
<label>Payment Method *</label>
<select id="paymentMethod" required>
<option>Cash</option>
<option>Credit Card</option>
<option>Debit Card</option>
<option>Insurance</option>
<option>Check</option>
</select>
</div>
<div class="form-group">
<label>Notes</label>
<textarea id="paymentNotes" rows="2" placeholder="Additional payment notes"></textarea>
</div>
<button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Confirm Payment</button>
</form>
</div>
</div>

<div id="withdrawModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-hand-holding-usd"></i> Withdraw Money</h3>
<button class="close-modal" onclick="closeModal('withdrawModal')">&times;</button>
</div>
<form onsubmit="withdrawMoney(event)">
<div class="form-group">
<label>Current Balance</label>
<input type="text" id="withdrawCurrentBalance" readonly style="font-size:1.3em;font-weight:700;color:var(--success);">
</div>
<div class="form-group">
<label>Withdrawal Amount *</label>
<input type="number" id="withdrawAmount" step="0.01" min="0.01" placeholder="Enter amount to withdraw" required>
</div>
<div class="form-group">
<label>Withdrawal Method *</label>
<select id="withdrawMethod" required>
<option>Bank Transfer</option>
<option>Cash</option>
<option>Check</option>
</select>
</div>
<div class="form-group">
<label>Notes</label>
<textarea id="withdrawNotes" rows="2" placeholder="Reason for withdrawal"></textarea>
</div>
<button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Withdraw</button>
</form>
</div>
</div>

<div id="addPatientModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-user-plus"></i> Register New Patient</h3>
<button class="close-modal" onclick="closeModal('addPatientModal')">&times;</button>
</div>
<form onsubmit="addPatient(event)">
<div class="form-row">
<div class="form-group"><label>First Name *</label><input type="text" id="patFirstName" required></div>
<div class="form-group"><label>Last Name *</label><input type="text" id="patLastName" required></div>
</div>
<div class="form-row">
<div class="form-group"><label>Date of Birth *</label><input type="date" id="patDOB" required></div>
<div class="form-group"><label>Medicare ID *</label><input type="text" id="patMedicareID" required></div>
</div>
<div class="form-row">
<div class="form-group"><label>Phone *</label><input type="tel" id="patPhone" required></div>
<div class="form-group"><label>Blood Group</label><select id="patBloodGroup"><option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option></select></div>
</div>
<div class="form-group"><label>Address *</label><textarea id="patAddress" rows="3" required></textarea></div>
<div class="form-group"><label>Insurance Status</label><select id="patInsurance"><option>Active Medicare</option><option>Medicare Pending</option><option>Private Insurance</option></select></div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Register Patient</button>
</form>
</div>
</div>

<div id="scheduleModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-calendar-plus"></i> Schedule Appointment</h3>
<button class="close-modal" onclick="closeModal('scheduleModal')">&times;</button>
</div>
<form onsubmit="scheduleAppointment(event)">
<div class="form-group"><label>Patient *</label><select id="schedPatient" required></select></div>
<div class="form-group"><label>Doctor *</label><select id="schedDoctor" required><option>Dr. Smith - Cardiology</option><option>Dr. Johnson - Neurology</option><option>Dr. Williams - General</option><option>Dr. Brown - Pediatrics</option><option>Dr. Davis - Orthopedics</option></select></div>
<div class="form-row">
<div class="form-group"><label>Date *</label><input type="date" id="schedDate" required></div>
<div class="form-group"><label>Time *</label><input type="time" id="schedTime" required></div>
</div>
<div class="form-group"><label>Reason *</label><textarea id="schedReason" rows="3" required></textarea></div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Schedule</button>
</form>
</div>
</div>

<div id="checkInModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-sign-in-alt"></i> Patient Check-In</h3>
<button class="close-modal" onclick="closeModal('checkInModal')">&times;</button>
</div>
<form onsubmit="checkInPatient(event)">
<div class="form-group"><label>Select Appointment *</label><select id="checkInAppt" required></select></div>
<div class="form-group"><label>Verify Medicare Coverage</label><select id="checkInCoverage"><option>Active - Verified</option><option>Pending Verification</option><option>Expired</option></select></div>
<div class="form-group"><label>Copay Amount</label><input type="number" id="checkInCopay" placeholder="0.00" step="0.01"></div>
<button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Check-In</button>
</form>
</div>
</div>

<div id="checkOutModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-sign-out-alt"></i> Patient Check-Out</h3>
<button class="close-modal" onclick="closeModal('checkOutModal')">&times;</button>
</div>
<form onsubmit="checkOutPatient(event)">
<div class="form-group"><label>Select Patient *</label><select id="checkOutPatient" required></select></div>
<div class="form-group"><label>Follow-Up Required?</label><select id="checkOutFollowUp"><option>No</option><option>Yes - 1 Week</option><option>Yes - 2 Weeks</option><option>Yes - 1 Month</option></select></div>
<button type="submit" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i> Check-Out</button>
</form>
</div>
</div>

<div id="vitalsModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-notes-medical"></i> Record Vital Signs</h3>
<button class="close-modal" onclick="closeModal('vitalsModal')">&times;</button>
</div>
<form onsubmit="recordVitals(event)">
<div class="form-group"><label>Patient *</label><select id="vitalPatient" required></select></div>
<div class="form-row">
<div class="form-group"><label>BP *</label><input type="text" id="vitalBP" placeholder="120/80" required></div>
<div class="form-group"><label>Temp (°F) *</label><input type="text" id="vitalTemp" placeholder="98.6" required></div>
</div>
<div class="form-row">
<div class="form-group"><label>Heart Rate *</label><input type="number" id="vitalHR" placeholder="72" required></div>
<div class="form-group"><label>Weight (lbs) *</label><input type="number" id="vitalWeight" placeholder="150" required></div>
</div>
<div class="form-group"><label>O2 Saturation (%)</label><input type="number" id="vitalO2" placeholder="98"></div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Record Vitals</button>
</form>
</div>
</div>

<div id="historyModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-history"></i> Update Medical History</h3>
<button class="close-modal" onclick="closeModal('historyModal')">&times;</button>
</div>
<form onsubmit="updateHistory(event)">
<div class="form-group"><label>Patient *</label><select id="historyPatient" required></select></div>
<div class="form-group"><label>Current Medications</label><textarea id="historyMeds" rows="2" placeholder="List current medications"></textarea></div>
<div class="form-group"><label>Allergies</label><textarea id="historyAllergies" rows="2" placeholder="List allergies"></textarea></div>
<div class="form-group"><label>Chief Complaint *</label><textarea id="historyComplaint" rows="2" required></textarea></div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Update History</button>
</form>
</div>
</div>

<div id="examModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-file-medical"></i> Clinical Documentation</h3>
<button class="close-modal" onclick="closeModal('examModal')">&times;</button>
</div>
<form onsubmit="documentExam(event)">
<div class="form-group"><label>Patient *</label><select id="examPatient" required></select></div>
<div class="form-group"><label>Examination Findings *</label><textarea id="examFindings" rows="3" required></textarea></div>
<div class="form-group"><label>Diagnosis (ICD-10) *</label><input type="text" id="examDiagnosis" placeholder="e.g., I10 - Essential Hypertension" required></div>
<div class="form-group"><label>Treatment Plan *</label><textarea id="examTreatment" rows="3" required></textarea></div>
<div class="form-group"><label>Consultation Fee *</label><input type="number" id="examFee" placeholder="150.00" step="0.01" required></div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Document & Generate Bill</button>
</form>
</div>
</div>

<div id="prescriptionModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-prescription"></i> E-Prescribe</h3>
<button class="close-modal" onclick="closeModal('prescriptionModal')">&times;</button>
</div>
<form onsubmit="ePrescribe(event)">
<div class="form-group"><label>Patient *</label><select id="prescPatient" required></select></div>
<div class="form-group"><label>Medication *</label><input type="text" id="prescMed" placeholder="e.g., Lisinopril" required></div>
<div class="form-row">
<div class="form-group"><label>Dosage *</label><input type="text" id="prescDose" placeholder="10mg" required></div>
<div class="form-group"><label>Frequency *</label><input type="text" id="prescFreq" placeholder="Once daily" required></div>
</div>
<div class="form-group"><label>Duration *</label><input type="text" id="prescDuration" placeholder="30 days" required></div>
<div class="form-group"><label>Medicare Coverage</label><select id="prescCoverage"><option>Covered - Tier 1</option><option>Covered - Tier 2</option><option>Prior Auth Required</option><option>Not Covered</option></select></div>
<button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send to Pharmacy</button>
</form>
</div>
</div>

<div id="labOrderModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-flask"></i> Lab Order</h3>
<button class="close-modal" onclick="closeModal('labOrderModal')">&times;</button>
</div>
<form onsubmit="orderLab(event)">
<div class="form-group"><label>Patient *</label><select id="labPatient" required></select></div>
<div class="form-group"><label>Test Type *</label><select id="labTest" required><option>Complete Blood Count (CBC)</option><option>Basic Metabolic Panel</option><option>Lipid Panel</option><option>HbA1c</option><option>Urinalysis</option></select></div>
<div class="form-group"><label>Priority</label><select id="labPriority"><option>Routine</option><option>Urgent</option><option>STAT</option></select></div>
<div class="form-group"><label>Clinical Notes</label><textarea id="labNotes" rows="2"></textarea></div>
<button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Order Lab</button>
</form>
</div>
</div>

<div id="inventoryModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-boxes"></i> Manage Inventory</h3>
<button class="close-modal" onclick="closeModal('inventoryModal')">&times;</button>
</div>
<form onsubmit="addInventory(event)">
<div class="form-group"><label>Medication Name *</label><input type="text" id="invMedName" required></div>
<div class="form-row">
<div class="form-group"><label>Quantity *</label><input type="number" id="invQuantity" required></div>
<div class="form-group"><label>Unit Price *</label><input type="number" id="invPrice" step="0.01" required></div>
</div>
<div class="form-row">
<div class="form-group"><label>Expiry Date *</label><input type="date" id="invExpiry" required></div>
<div class="form-group"><label>Batch Number</label><input type="text" id="invBatch"></div>
</div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Add to Inventory</button>
</form>
</div>
</div>

<div id="dispenseMedModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-hand-holding-medical"></i> Dispense Medication</h3>
<button class="close-modal" onclick="closeModal('dispenseMedModal')">&times;</button>
</div>
<form onsubmit="dispenseMedication(event)">
<div class="form-group"><label>Select Prescription *</label><select id="dispensePrescription" required></select></div>
<div class="form-group"><label>Quantity Dispensed *</label><input type="number" id="dispenseQuantity" required></div>
<div class="form-group"><label>Instructions to Patient</label><textarea id="dispenseInstructions" rows="3" placeholder="Take with food, avoid alcohol, etc."></textarea></div>
<div class="form-group"><label>Pharmacist Notes</label><textarea id="dispenseNotes" rows="2"></textarea></div>
<button type="submit" class="btn btn-success"><i class="fas fa-check"></i> Dispense</button>
</form>
</div>
</div>

<div id="refillModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-redo"></i> Process Refill Request</h3>
<button class="close-modal" onclick="closeModal('refillModal')">&times;</button>
</div>
<form onsubmit="processRefill(event)">
<div class="form-group"><label>Patient *</label><select id="refillPatient" required></select></div>
<div class="form-group"><label>Medication *</label><input type="text" id="refillMed" required></div>
<div class="form-group"><label>Original Prescription Date</label><input type="date" id="refillOrigDate"></div>
<div class="form-group"><label>Refill Authorization</label><select id="refillAuth"><option>Approved by Doctor</option><option>Pending Doctor Approval</option><option>Denied</option></select></div>
<button type="submit" class="btn btn-warning"><i class="fas fa-redo"></i> Process Refill</button>
</form>
</div>
</div>

<div id="copayModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-dollar-sign"></i> Collect Copay</h3>
<button class="close-modal" onclick="closeModal('copayModal')">&times;</button>
</div>
<form onsubmit="collectCopay(event)">
<div class="form-group"><label>Patient *</label><select id="copayPatient" required></select></div>
<div class="form-group"><label>Amount *</label><input type="number" id="copayAmount" step="0.01" required></div>
<div class="form-group"><label>Payment Method *</label><select id="copayMethod" required><option>Cash</option><option>Credit Card</option><option>Debit Card</option><option>Check</option></select></div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Process Payment</button>
</form>
</div>
</div>

<div id="claimModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-file-invoice"></i> Submit Medicare Claim</h3>
<button class="close-modal" onclick="closeModal('claimModal')">&times;</button>
</div>
<form onsubmit="submitClaim(event)">
<div class="form-group"><label>Patient *</label><select id="claimPatient" required></select></div>
<div class="form-group"><label>Service Code (CPT) *</label><input type="text" id="claimCPT" placeholder="e.g., 99213" required></div>
<div class="form-group"><label>Diagnosis Code (ICD-10) *</label><input type="text" id="claimICD" placeholder="e.g., I10" required></div>
<div class="form-group"><label>Charge Amount *</label><input type="number" id="claimAmount" step="0.01" required></div>
<button type="submit" class="btn btn-success"><i class="fas fa-paper-plane"></i> Submit Claim</button>
</form>
</div>
</div>

<div id="registerUserModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3><i class="fas fa-user-plus"></i> Register New User</h3>
<button class="close-modal" onclick="closeModal('registerUserModal')">&times;</button>
</div>
<form onsubmit="registerUser(event)">
<div class="form-group"><label>Full Name *</label><input type="text" id="newUserName" required></div>
<div class="form-group"><label>Email *</label><input type="email" id="newUserEmail" required></div>
<div class="form-group"><label>Role *</label><select id="newUserRole" required><option value="">Select Role</option><option value="doctor">Doctor</option><option value="nurse">Nurse</option><option value="receptionist">Receptionist</option><option value="pharmacy">Pharmacy</option></select></div>
<div class="form-group"><label>Password *</label><div class="password-input"><input type="password" id="newUserPassword" required minlength="6"><i class="fas fa-eye password-toggle" onclick="togglePassword('newUserPassword')"></i></div></div>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Register User</button>
</form>
</div>
</div>

<script>
let patients=JSON.parse(localStorage.getItem('patients')||'[]');
let appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
let vitals=JSON.parse(localStorage.getItem('vitals')||'[]');
let exams=JSON.parse(localStorage.getItem('exams')||'[]');
let prescriptions=JSON.parse(localStorage.getItem('prescriptions')||'[]');
let labs=JSON.parse(localStorage.getItem('labs')||'[]');
let billing=JSON.parse(localStorage.getItem('billing')||'[]');
let payments=JSON.parse(localStorage.getItem('payments')||'[]');
let inventory=JSON.parse(localStorage.getItem('inventory')||'[]');
let dispensed=JSON.parse(localStorage.getItem('dispensed')||'[]');
let users=JSON.parse(localStorage.getItem('users')||'[]');
let messages=JSON.parse(localStorage.getItem('messages')||'[]');
let transactions=JSON.parse(localStorage.getItem('transactions')||'[]');
let archives=JSON.parse(localStorage.getItem('archives')||'[]');
let accountBalance=parseFloat(localStorage.getItem('accountBalance')||'0');
let currentUser=null;
let currentPaymentData=null;

if(users.length===0){users=[
{id:'U1',name:'Dr. Admin',email:'admin@medicare.com',password:'admin123',role:'admin'},
{id:'U2',name:'Reception Desk',email:'reception@medicare.com',password:'recep123',role:'receptionist'},
{id:'U3',name:'Nurse Station',email:'nurse@medicare.com',password:'nurse123',role:'nurse'},
{id:'U4',name:'Dr. Smith',email:'doctor@medicare.com',password:'doctor123',role:'doctor'},
{id:'U5',name:'Pharmacy Dept',email:'pharmacy@medicare.com',password:'pharma123',role:'pharmacy'}
];localStorage.setItem('users',JSON.stringify(users));}

const rolePerms={
admin:{sections:['dashboard','reception','nursing','clinical','pharmacy','billing','patients','archives','messages','settings'],canAll:true},
doctor:{sections:['dashboard','clinical','patients','messages'],canAll:false},
nurse:{sections:['dashboard','nursing','patients','messages'],canAll:false},
receptionist:{sections:['dashboard','reception','billing','patients','archives','messages'],canAll:false},
pharmacy:{sections:['dashboard','pharmacy','patients','messages'],canAll:false}
};

setInterval(function(){
if(currentUser){
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
messages=JSON.parse(localStorage.getItem('messages')||'[]');
prescriptions=JSON.parse(localStorage.getItem('prescriptions')||'[]');
updateMessageCount();
}
},2000);

function sendMessage(toRole,patientName,message,type){
const msg={id:'MSG'+Date.now(),from:currentUser.role,fromName:currentUser.name,to:toRole,patientName:patientName,message:message,type:type,read:false,createdAt:new Date().toISOString()};
messages.push(msg);
localStorage.setItem('messages',JSON.stringify(messages));
updateMessageCount();
}

function updateMessageCount(){
if(!currentUser)return;
const unread=messages.filter(m=>m.to===currentUser.role&&!m.read).length;
const badge=document.getElementById('messageCount');
if(badge){
if(unread>0){badge.textContent=unread;badge.style.display='flex';}
else{badge.style.display='none';}
}
}

function loadMessages(){
const myMessages=messages.filter(m=>m.to===currentUser.role).sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
const div=document.getElementById('messagesList');
div.innerHTML=myMessages.map(m=>`<div class="message-card ${m.read?'':'unread'}" onclick="markAsRead('${m.id}')"><div class="message-header"><span class="message-from"><i class="fas fa-user-circle"></i> ${m.fromName}</span><span class="message-time">${new Date(m.createdAt).toLocaleString()}</span></div><div class="message-content">${m.message}</div><div class="message-patient"><i class="fas fa-user"></i> Patient: ${m.patientName}</div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:40px;">No messages yet</p>';
}

function markAsRead(id){
const msg=messages.find(m=>m.id===id);
if(msg){msg.read=true;localStorage.setItem('messages',JSON.stringify(messages));updateMessageCount();loadMessages();}
}

function showToast(title,message){
const toast=document.getElementById('notificationToast');
toast.innerHTML=`<h4><i class="fas fa-bell"></i> ${title}</h4><p>${message}</p>`;
toast.classList.add('show');
setTimeout(()=>{toast.classList.remove('show');},5000);
}

function addTransaction(type,amount,description){
const trans={id:'T'+Date.now(),type:type,amount:amount,description:description,balance:accountBalance,createdBy:currentUser.name,createdAt:new Date().toISOString()};
transactions.push(trans);
localStorage.setItem('transactions',JSON.stringify(transactions));
}

function loadTransactionHistory(){
const div=document.getElementById('transactionHistory');
const recent=transactions.slice(-20).reverse();
div.innerHTML=recent.map(t=>`<div class="task-card"><div class="task-header"><h4>${t.type==='deposit'?'💰 Payment Received':'💸 Withdrawal'}</h4><span class="badge badge-${t.type==='deposit'?'success':'warning'}">$${t.amount.toFixed(2)}</span></div><div class="task-body"><div class="task-item"><label>Description</label><span>${t.description}</span></div><div class="task-item"><label>Balance After</label><span>$${t.balance.toFixed(2)}</span></div><div class="task-item"><label>By</label><span>${t.createdBy}</span></div><div class="task-item"><label>Date</label><span>${new Date(t.createdAt).toLocaleString()}</span></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No transactions yet</p>';
}

function updateFinancialDisplay(){
document.getElementById('currentBalance').textContent='$'+accountBalance.toFixed(2);
const totalCollected=transactions.filter(t=>t.type==='deposit').reduce((sum,t)=>sum+t.amount,0);
document.getElementById('totalCollected').textContent='$'+totalCollected.toFixed(2);
}

function withdrawMoney(e){
e.preventDefault();
const amount=parseFloat(document.getElementById('withdrawAmount').value);
if(amount>accountBalance){alert('❌ Insufficient balance!');return;}
accountBalance-=amount;
localStorage.setItem('accountBalance',accountBalance.toString());
addTransaction('withdrawal',amount,`${document.getElementById('withdrawMethod').value} - ${document.getElementById('withdrawNotes').value||'No notes'}`);
showAlert('Money withdrawn successfully!');
showToast('Withdrawal Successful',`$${amount.toFixed(2)} withdrawn`);
closeModal('withdrawModal');
e.target.reset();
updateFinancialDisplay();
loadTransactionHistory();
}

function resetAccount(){
if(confirm('⚠️ Are you sure you want to reset the account balance to $0?')){
accountBalance=0;
transactions=[];
localStorage.setItem('accountBalance','0');
localStorage.setItem('transactions',JSON.stringify(transactions));
showAlert('Account reset to $0');
updateFinancialDisplay();
loadTransactionHistory();
}
}

function clearMessages(){
if(confirm('⚠️ Clear all messages?')){
messages=[];
localStorage.setItem('messages',JSON.stringify(messages));
showAlert('All messages cleared!');
loadMessages();
updateMessageCount();
}
}

function clearArchives(){
if(confirm('⚠️ Clear all archives?')){
archives=[];
dispensed=[];
payments=[];
localStorage.setItem('archives',JSON.stringify(archives));
localStorage.setItem('dispensed',JSON.stringify(dispensed));
localStorage.setItem('payments',JSON.stringify(payments));
showAlert('Archives cleared!');
loadArchives();
}
}

function resetSystem(){
if(confirm('🚨 RESET ENTIRE SYSTEM?')){
if(confirm('⚠️ FINAL WARNING: This action CANNOT be undone!')){
patients=[];
appointments=[];
vitals=[];
exams=[];
prescriptions=[];
labs=[];
billing=[];
payments=[];
inventory=[];
dispensed=[];
messages=[];
transactions=[];
archives=[];
accountBalance=0;
localStorage.clear();
localStorage.setItem('users',JSON.stringify(users));
showAlert('System reset complete!');
updateDashboard();
updateFinancialDisplay();
loadMessages();
loadArchives();
}
}
}

function exportData(){
const data={patients,appointments,vitals,exams,prescriptions,labs,billing,payments,inventory,dispensed,messages,transactions,archives,accountBalance,exportDate:new Date().toISOString()};
const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`medicare-backup-${new Date().toISOString().split('T')[0]}.json`;
a.click();
URL.revokeObjectURL(url);
showAlert('Data exported successfully!');
}

function openPaymentModal(paymentData){
currentPaymentData=paymentData;
const details=document.getElementById('paymentDetails');
details.innerHTML=`<div class="payment-card"><h4>Payment Summary</h4><div class="payment-details"><div class="payment-row"><strong>Patient:</strong><span>${paymentData.patientName}</span></div><div class="payment-row"><strong>Service:</strong><span>${paymentData.service}</span></div><div class="payment-row"><strong>Consultation Fee:</strong><span>$${paymentData.amount.toFixed(2)}</span></div><div class="payment-total">Total Amount: $${paymentData.amount.toFixed(2)}</div></div></div>`;
openModal('paymentModal');
}

function processPayment(e){
e.preventDefault();
if(!currentPaymentData)return;
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
exams=JSON.parse(localStorage.getItem('exams')||'[]');
prescriptions=JSON.parse(localStorage.getItem('prescriptions')||'[]');
console.log('💳 PAYMENT PROCESSING START');
console.log('💳 Patient ID:', currentPaymentData.patientId);
console.log('💳 All appointments BEFORE payment:', appointments.map(a=>({name:a.patientName,id:a.patientId,status:a.status})));
const payment={id:'PAY'+Date.now(),patientId:currentPaymentData.patientId,patientName:currentPaymentData.patientName,amount:currentPaymentData.amount,service:currentPaymentData.service,method:document.getElementById('paymentMethod').value,notes:document.getElementById('paymentNotes').value,status:'paid',processedBy:currentUser.name,createdAt:new Date().toISOString()};
payments.push(payment);
localStorage.setItem('payments',JSON.stringify(payments));
accountBalance+=currentPaymentData.amount;
localStorage.setItem('accountBalance',accountBalance.toString());
addTransaction('deposit',currentPaymentData.amount,`Payment from ${currentPaymentData.patientName}`);
const appt=appointments.find(a=>a.patientId===currentPaymentData.patientId&&a.status==='exam-done');
if(appt){
appt.status='payment-done';
appt.paymentId=payment.id;
appt.paymentStatus='paid';
localStorage.setItem('appointments',JSON.stringify(appointments));
console.log('✅ PAYMENT SUCCESS - Appointment updated to payment-done');
console.log('✅ Updated appointment:', appt);
}else{
console.log('❌ PAYMENT FAILED - No exam-done appointment found');
console.log('❌ Available appointments:', appointments.filter(a=>a.patientId===currentPaymentData.patientId));
}
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
console.log('💳 All appointments AFTER payment:', appointments.map(a=>({name:a.patientName,id:a.patientId,status:a.status})));
sendMessage('pharmacy',currentPaymentData.patientName,`💰 Payment confirmed: $${currentPaymentData.amount.toFixed(2)}. Please dispense medication.`,'payment');
showAlert('Payment processed successfully!');
showToast('Payment Received',`$${currentPaymentData.amount.toFixed(2)}`);
closeModal('paymentModal');
document.getElementById('paymentNotes').value='';
currentPaymentData=null;
updateDashboard();
updateFinancialDisplay();
loadPendingPayments();
loadAllAppointments();
}

function loadPendingPayments(){
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
exams=JSON.parse(localStorage.getItem('exams')||'[]');
const pending=appointments.filter(a=>a.status==='exam-done'||a.status==='payment-done');
const div=document.getElementById('pendingPayments');
div.innerHTML=pending.map(a=>{
const exam=exams.find(e=>e.patientId===a.patientId);
const isPaid=a.status==='payment-done';
return`<div class="task-card"><div class="task-header"><h4>${a.patientName}</h4><span class="badge badge-${isPaid?'success':'warning'}">${isPaid?'✅ Paid':'⏳ Payment Pending'}</span></div><div class="task-body"><div class="task-item"><label>Doctor</label><span>${a.doctor}</span></div><div class="task-item"><label>Diagnosis</label><span>${exam?exam.diagnosis:'N/A'}</span></div><div class="task-item"><label>Amount</label><span>$${exam?exam.fee.toFixed(2):'0.00'}</span></div><div class="task-item"><label>Status</label><span>${a.status}</span></div></div>${!isPaid?`<button class="btn btn-success btn-sm" onclick='openPaymentModal({patientId:"${a.patientId}",patientName:"${a.patientName}",amount:${exam?exam.fee:0},service:"Consultation Fee"})'><i class="fas fa-credit-card"></i> Process Payment</button>`:''}</div>`;
}).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No pending payments</p>';
}

function loadArchives(){
const div=document.getElementById('archivesList');
const isAdmin=currentUser.role==='admin';
if(isAdmin){
const patientVisits=archives.filter(a=>a.type==='patient-visit');
const pharmacyRecords=dispensed;
const paymentRecords=payments;
div.innerHTML=`
<div class="card" style="margin-bottom:20px;">
<h3 style="color:var(--primary);margin-bottom:15px;"><i class="fas fa-user-injured"></i> Patient Visit Archives (${patientVisits.length})</h3>
${patientVisits.slice().reverse().map(a=>`<div class="archive-card"><div class="task-header"><h4>${a.patientName}</h4><span class="badge badge-info">Archived</span></div><div class="task-body"><div class="task-item"><label>Date</label><span>${a.date}</span></div><div class="task-item"><label>Doctor</label><span>${a.doctor}</span></div><div class="task-item"><label>Diagnosis</label><span>${a.diagnosis||'N/A'}</span></div><div class="task-item"><label>Medication</label><span>${a.medication||'N/A'}</span></div><div class="task-item"><label>Archived On</label><span>${new Date(a.archivedAt).toLocaleDateString()}</span></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No patient visit archives</p>'}
</div>
<div class="card" style="margin-bottom:20px;">
<h3 style="color:var(--success);margin-bottom:15px;"><i class="fas fa-pills"></i> Pharmacy Archives (${pharmacyRecords.length})</h3>
${pharmacyRecords.slice().reverse().map(d=>`<div class="archive-card" style="border-left-color:var(--success);"><div class="task-header"><h4>${d.medication}</h4><span class="badge badge-success">Dispensed</span></div><div class="task-body"><div class="task-item"><label>Patient</label><span>${d.patientName}</span></div><div class="task-item"><label>Quantity</label><span>${d.quantity}</span></div><div class="task-item"><label>Date</label><span>${new Date(d.dispensedAt).toLocaleString()}</span></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No pharmacy archives</p>'}
</div>
<div class="card">
<h3 style="color:var(--warning);margin-bottom:15px;"><i class="fas fa-dollar-sign"></i> Payment Archives (${paymentRecords.length})</h3>
${paymentRecords.slice().reverse().map(p=>`<div class="archive-card" style="border-left-color:var(--warning);"><div class="task-header"><h4>${p.patientName}</h4><span class="badge badge-success">$${p.amount.toFixed(2)}</span></div><div class="task-body"><div class="task-item"><label>Service</label><span>${p.service}</span></div><div class="task-item"><label>Method</label><span>${p.method}</span></div><div class="task-item"><label>Date</label><span>${new Date(p.createdAt).toLocaleString()}</span></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No payment archives</p>'}
</div>
`;
}else{
const filteredArchives=archives.filter(a=>a.type==='patient-visit');
div.innerHTML=filteredArchives.slice().reverse().map(a=>`<div class="archive-card"><div class="task-header"><h4>${a.patientName}</h4><span class="badge badge-info">Archived</span></div><div class="task-body"><div class="task-item"><label>Date</label><span>${a.date}</span></div><div class="task-item"><label>Doctor</label><span>${a.doctor}</span></div><div class="task-item"><label>Diagnosis</label><span>${a.diagnosis||'N/A'}</span></div><div class="task-item"><label>Medication</label><span>${a.medication||'N/A'}</span></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:40px;">No archived records</p>';
}
}

function toggleTheme(){
const html=document.documentElement;
const theme=html.getAttribute('data-theme')==='dark'?'light':'dark';
html.setAttribute('data-theme',theme);
localStorage.setItem('theme',theme);
document.getElementById('themeIcon').className=theme==='dark'?'fas fa-sun':'fas fa-moon';
}

window.addEventListener('load',()=>{
const theme=localStorage.getItem('theme')||'light';
document.documentElement.setAttribute('data-theme',theme);
document.getElementById('themeIcon').className=theme==='dark'?'fas fa-sun':'fas fa-moon';
const saved=localStorage.getItem('currentUser');
if(saved){currentUser=JSON.parse(saved);showMainApp();}
});

function togglePassword(id){
const input=document.getElementById(id);
const icon=event.target;
if(input.type==='password'){input.type='text';icon.className='fas fa-eye-slash';}
else{input.type='password';icon.className='fas fa-eye';}
}

function handleLogin(e){
e.preventDefault();
const email=document.getElementById('loginEmail').value;
const password=document.getElementById('loginPassword').value;
const user=users.find(u=>u.email===email&&u.password===password);
if(user){currentUser=user;localStorage.setItem('currentUser',JSON.stringify(currentUser));showMainApp();}
else{alert('❌ Invalid credentials!');}
}

function switchAccount(e){
e.preventDefault();
const role=document.getElementById('switchRole').value;
const password=document.getElementById('switchPassword').value;
const user=users.find(u=>u.role===role&&u.password===password);
if(user){currentUser=user;localStorage.setItem('currentUser',JSON.stringify(currentUser));closeModal('switchAccountModal');showMainApp();showAlert('Account switched!');e.target.reset();}
else{alert('❌ Invalid password!');}
}

function showMainApp(){
document.getElementById('loginPage').style.display='none';
document.getElementById('mainApp').style.display='block';
document.getElementById('userName').textContent=currentUser.name;
const roleClass='role-'+currentUser.role;
const roleText=currentUser.role.charAt(0).toUpperCase()+currentUser.role.slice(1);
document.getElementById('userRoleBadge').innerHTML=`<span class="role-badge ${roleClass}">${roleText}</span>`;
document.getElementById('userInitials').textContent=currentUser.name.split(' ').map(n=>n[0]).join('').toUpperCase();
document.getElementById('profileName').value=currentUser.name;
document.getElementById('profileEmail').value=currentUser.email;
document.getElementById('profileRole').value=currentUser.role;
buildMenu();
applyPerms();
updateDashboard();
updateMessageCount();
updateFinancialDisplay();
if(currentUser.role==='admin'){
document.getElementById('databaseViewerCard').style.display='block';
showDbTab('diagram');
}
}

function buildMenu(){
const menu=document.getElementById('sidebarMenu');
const perms=rolePerms[currentUser.role];
const items={
dashboard:{icon:'chart-line',label:'Dashboard'},
reception:{icon:'desk',label:'Reception'},
nursing:{icon:'heartbeat',label:'Nursing'},
clinical:{icon:'stethoscope',label:'Clinical'},
pharmacy:{icon:'pills',label:'Pharmacy'},
billing:{icon:'file-invoice-dollar',label:'Billing'},
patients:{icon:'users',label:'Patients'},
archives:{icon:'archive',label:'Archives'},
messages:{icon:'envelope',label:'Messages'},
settings:{icon:'cog',label:'Settings'}
};
menu.innerHTML='';
perms.sections.forEach((sec,i)=>{
if(items[sec]){
const li=document.createElement('li');
li.className=i===0?'active':'';
li.onclick=function(){showSection(sec);};
li.innerHTML=`<i class="fas fa-${items[sec].icon}"></i><span>${items[sec].label}</span>`;
if(sec==='messages'){
const unread=messages.filter(m=>m.to===currentUser.role&&!m.read).length;
if(unread>0){li.innerHTML+=`<span class="notification-badge">${unread}</span>`;}
}
menu.appendChild(li);
}
});
}

function applyPerms(){
document.getElementById('userManagementCard').style.display=currentUser.role==='admin'?'block':'none';
document.getElementById('financialManagementCard').style.display=currentUser.role==='admin'?'block':'none';
document.getElementById('systemManagementCard').style.display=currentUser.role==='admin'?'block':'none';
document.getElementById('databaseViewerCard').style.display=currentUser.role==='admin'?'block':'none';
}

function handleLogout(auto=false){
if(auto||confirm('Logout?')){
currentUser=null;
localStorage.removeItem('currentUser');
document.getElementById('loginPage').style.display='flex';
document.getElementById('mainApp').style.display='none';
document.getElementById('loginForm').reset();
}
}

function toggleUserMenu(){
document.getElementById('userMenu').classList.toggle('show');
}

document.addEventListener('click',function(event){
const userDropdown=document.querySelector('.user-dropdown');
const userMenu=document.getElementById('userMenu');
if(userMenu&&!userDropdown.contains(event.target)){userMenu.classList.remove('show');}
});

function showSection(sec){
document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
document.querySelectorAll('.sidebar-menu li').forEach(i=>i.classList.remove('active'));
document.getElementById(sec).classList.add('active');
event.target.closest('li').classList.add('active');
const titles={dashboard:'Dashboard',reception:'Reception Desk',nursing:'Nursing Station',clinical:'Clinical Workspace',pharmacy:'Pharmacy Management',billing:'Billing & Claims',patients:'Patient Registry',archives:'Archives',messages:'Messages & Notifications',settings:'Settings'};
document.getElementById('pageTitle').textContent=titles[sec]||'Dashboard';
if(sec==='patients')loadPatients();
if(sec==='reception'){loadAllAppointments();loadPendingPayments();}
if(sec==='nursing')loadPatientsForVitals();
if(sec==='clinical')loadPatientsForDoctor();
if(sec==='pharmacy')loadPharmacyData();
if(sec==='billing')loadPendingBilling();
if(sec==='messages')loadMessages();
if(sec==='archives')loadArchives();
if(sec==='settings'){loadUsers();loadTransactionHistory();updateFinancialDisplay();}
}

function openModal(id){
document.getElementById(id).classList.add('show');
if(id==='withdrawModal'){document.getElementById('withdrawCurrentBalance').value='$'+accountBalance.toFixed(2);}
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
prescriptions=JSON.parse(localStorage.getItem('prescriptions')||'[]');
patients=JSON.parse(localStorage.getItem('patients')||'[]');
if(['scheduleModal','checkInModal','vitalsModal','historyModal','examModal','prescriptionModal','labModal','copayModal','claimModal','dispenseMedModal','refillModal','checkOutModal'].some(m=>id.includes(m.replace('Modal',''))))populateDropdowns();
}

function closeModal(id){
document.getElementById(id).classList.remove('show');
}

function showAlert(msg,type='success'){
const alert=document.getElementById('alert');
alert.className=`alert alert-${type} show`;
alert.innerHTML=`<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> ${msg}`;
setTimeout(()=>alert.classList.remove('show'),3000);
}

function addPatient(e){
e.preventDefault();
const patient={id:'P'+Date.now(),firstName:document.getElementById('patFirstName').value,lastName:document.getElementById('patLastName').value,dob:document.getElementById('patDOB').value,medicareID:document.getElementById('patMedicareID').value,phone:document.getElementById('patPhone').value,bloodGroup:document.getElementById('patBloodGroup').value,address:document.getElementById('patAddress').value,insurance:document.getElementById('patInsurance').value,status:'registered',createdAt:new Date().toISOString()};
patients.push(patient);
localStorage.setItem('patients',JSON.stringify(patients));
showAlert('Patient registered successfully!');
closeModal('addPatientModal');
e.target.reset();
updateDashboard();
}

function scheduleAppointment(e){
e.preventDefault();
const patientId=document.getElementById('schedPatient').value;
const patient=patients.find(p=>p.id===patientId);
const patientName=`${patient.firstName} ${patient.lastName}`;
const appt={id:'A'+Date.now(),patientId:patientId,patientName:patientName,doctor:document.getElementById('schedDoctor').value,date:document.getElementById('schedDate').value,time:document.getElementById('schedTime').value,reason:document.getElementById('schedReason').value,status:'scheduled',createdAt:new Date().toISOString()};
appointments.push(appt);
localStorage.setItem('appointments',JSON.stringify(appointments));
sendMessage('nurse',patientName,`📅 New appointment scheduled for ${appt.date} at ${appt.time}.`,'appointment');
showAlert('Appointment scheduled!');
showToast('Appointment Scheduled',`${patientName} scheduled`);
closeModal('scheduleModal');
e.target.reset();
updateDashboard();
loadAllAppointments();
}

function checkInPatient(e){
e.preventDefault();
const apptId=document.getElementById('checkInAppt').value;
const appt=appointments.find(a=>a.id===apptId);
if(appt&&appt.status==='scheduled'){
appt.status='checked-in';
appt.coverage=document.getElementById('checkInCoverage').value;
appt.copay=document.getElementById('checkInCopay').value;
localStorage.setItem('appointments',JSON.stringify(appointments));
sendMessage('nurse',appt.patientName,`✅ Patient checked in. Please record vitals.`,'checkin');
showAlert('Patient checked in!');
showToast('Patient Checked In',`${appt.patientName} ready`);
closeModal('checkInModal');
e.target.reset();
updateDashboard();
loadAllAppointments();
}else{alert('❌ Can only check-in scheduled appointments!');}
}

function checkOutPatient(e){
e.preventDefault();
const patientId=document.getElementById('checkOutPatient').value;
if(!patientId){alert('❌ Please select a patient!');return;}
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
exams=JSON.parse(localStorage.getItem('exams')||'[]');
prescriptions=JSON.parse(localStorage.getItem('prescriptions')||'[]');
dispensed=JSON.parse(localStorage.getItem('dispensed')||'[]');
console.log('🚪 CHECKOUT START');
console.log('🚪 Looking for patientId:', patientId);
console.log('🚪 All appointments:', appointments.map(a=>({name:a.patientName,id:a.patientId,status:a.status})));
const appt=appointments.find(a=>a.patientId===patientId&&a.status==='medication-ready');
if(appt){
const exam=exams.find(ex=>ex.patientId===patientId);
const presc=prescriptions.find(p=>p.patientId===patientId);
const archive={
id:'ARC'+Date.now(),
appointmentId:appt.id,
patientId:appt.patientId,
patientName:appt.patientName,
doctor:appt.doctor,
date:appt.date,
time:appt.time,
reason:appt.reason,
diagnosis:exam?exam.diagnosis:'N/A',
treatment:exam?exam.treatment:'N/A',
fee:exam?exam.fee:0,
medication:presc?presc.medication:'N/A',
dosage:presc?presc.dosage:'N/A',
followUp:document.getElementById('checkOutFollowUp').value,
archivedAt:new Date().toISOString(),
archivedBy:currentUser.name,
type:'patient-visit'
};
archives.push(archive);
localStorage.setItem('archives',JSON.stringify(archives));
appointments=appointments.filter(a=>a.id!==appt.id);
localStorage.setItem('appointments',JSON.stringify(appointments));
console.log('✅ CHECKOUT SUCCESS - Patient archived');
showAlert('Patient checked out and archived!');
showToast('Check-Out Complete',`${appt.patientName} completed`);
closeModal('checkOutModal');
e.target.reset();
updateDashboard();
loadAllAppointments();
loadArchives();
}else{
const readyAppts=appointments.filter(a=>a.status==='medication-ready');
console.log('❌ CHECKOUT FAILED');
console.log('❌ Medication-ready patients:', readyAppts);
alert(`❌ Patient not ready for checkout!\n\nRequired status: medication-ready\n\nPatients ready:\n${readyAppts.map(a=>a.patientName+' ('+a.status+')').join('\n') || 'None'}`);
}
}

function recordVitals(e){
e.preventDefault();
const patientId=document.getElementById('vitalPatient').value;
const patient=patients.find(p=>p.id===patientId);
const patientName=`${patient.firstName} ${patient.lastName}`;
const vital={id:'V'+Date.now(),patientId:patientId,patientName:patientName,bp:document.getElementById('vitalBP').value,temp:document.getElementById('vitalTemp').value,hr:document.getElementById('vitalHR').value,weight:document.getElementById('vitalWeight').value,o2:document.getElementById('vitalO2').value,recordedBy:currentUser.name,recordedAt:new Date().toISOString()};
vitals.push(vital);
localStorage.setItem('vitals',JSON.stringify(vitals));
const appt=appointments.find(a=>a.patientId===patientId&&a.status==='checked-in');
if(appt){appt.status='vitals-done';localStorage.setItem('appointments',JSON.stringify(appointments));}
sendMessage('doctor',patientName,`🩺 Vitals recorded. Patient ready for consultation.`,'vitals');
showAlert('Vitals recorded!');
showToast('Vitals Recorded',`${patientName} ready`);
closeModal('vitalsModal');
e.target.reset();
}

function updateHistory(e){
e.preventDefault();
const patientId=document.getElementById('historyPatient').value;
const patient=patients.find(p=>p.id===patientId);
patient.medications=document.getElementById('historyMeds').value;
patient.allergies=document.getElementById('historyAllergies').value;
patient.complaint=document.getElementById('historyComplaint').value;
localStorage.setItem('patients',JSON.stringify(patients));
showAlert('History updated!');
closeModal('historyModal');
e.target.reset();
}

function documentExam(e){
e.preventDefault();
const patientId=document.getElementById('examPatient').value;
const patient=patients.find(p=>p.id===patientId);
const patientName=`${patient.firstName} ${patient.lastName}`;
const fee=parseFloat(document.getElementById('examFee').value);
const exam={id:'E'+Date.now(),patientId:patientId,patientName:patientName,findings:document.getElementById('examFindings').value,diagnosis:document.getElementById('examDiagnosis').value,treatment:document.getElementById('examTreatment').value,fee:fee,doctor:currentUser.name,createdAt:new Date().toISOString()};
exams.push(exam);
localStorage.setItem('exams',JSON.stringify(exams));
const appt=appointments.find(a=>a.patientId===patientId&&a.status==='vitals-done');
if(appt){appt.status='exam-done';localStorage.setItem('appointments',JSON.stringify(appointments));}
sendMessage('receptionist',patientName,`📋 Exam completed. Fee: $${fee.toFixed(2)}. Please process payment.`,'exam');
showAlert('Exam documented!');
showToast('Exam Completed',`${patientName} ready for payment`);
closeModal('examModal');
e.target.reset();
loadPendingPayments();
}

function ePrescribe(e){
e.preventDefault();
const patientId=document.getElementById('prescPatient').value;
const patient=patients.find(p=>p.id===patientId);
const patientName=`${patient.firstName} ${patient.lastName}`;
const medication=document.getElementById('prescMed').value;
const presc={id:'RX'+Date.now(),patientId:patientId,patientName:patientName,medication:medication,dosage:document.getElementById('prescDose').value,frequency:document.getElementById('prescFreq').value,duration:document.getElementById('prescDuration').value,coverage:document.getElementById('prescCoverage').value,doctor:currentUser.name,status:'pending',createdAt:new Date().toISOString()};
prescriptions.push(presc);
localStorage.setItem('prescriptions',JSON.stringify(prescriptions));
sendMessage('pharmacy',patientName,`💊 New prescription: ${medication} ${presc.dosage}.`,'prescription');
showAlert('Prescription sent!');
showToast('Prescription Sent',`${medication} sent`);
closeModal('prescriptionModal');
e.target.reset();
loadPharmacyData();
}

function orderLab(e){
e.preventDefault();
const patientId=document.getElementById('labPatient').value;
const patient=patients.find(p=>p.id===patientId);
const lab={id:'L'+Date.now(),patientId:patientId,patientName:`${patient.firstName} ${patient.lastName}`,test:document.getElementById('labTest').value,priority:document.getElementById('labPriority').value,notes:document.getElementById('labNotes').value,orderedBy:currentUser.name,status:'pending',createdAt:new Date().toISOString()};
labs.push(lab);
localStorage.setItem('labs',JSON.stringify(labs));
showAlert('Lab order placed!');
closeModal('labOrderModal');
e.target.reset();
}

function addInventory(e){
e.preventDefault();
const item={id:'INV'+Date.now(),medication:document.getElementById('invMedName').value,quantity:parseInt(document.getElementById('invQuantity').value),price:parseFloat(document.getElementById('invPrice').value),expiry:document.getElementById('invExpiry').value,batch:document.getElementById('invBatch').value,addedBy:currentUser.name,createdAt:new Date().toISOString()};
inventory.push(item);
localStorage.setItem('inventory',JSON.stringify(inventory));
showAlert('Inventory updated!');
closeModal('inventoryModal');
e.target.reset();
}

function dispenseMedication(e){
e.preventDefault();
const prescId=document.getElementById('dispensePrescription').value;
if(!prescId){alert('❌ Please select a prescription!');return;}
prescriptions=JSON.parse(localStorage.getItem('prescriptions')||'[]');
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
console.log('💊 DISPENSE START');
console.log('💊 Prescription ID:', prescId);
const presc=prescriptions.find(p=>p.id===prescId);
if(presc){
const disp={id:'DISP'+Date.now(),prescriptionId:prescId,patientId:presc.patientId,patientName:presc.patientName,medication:presc.medication,dosage:presc.dosage,quantity:parseInt(document.getElementById('dispenseQuantity').value),instructions:document.getElementById('dispenseInstructions').value,notes:document.getElementById('dispenseNotes').value,dispensedBy:currentUser.name,dispensedAt:new Date().toISOString()};
dispensed.push(disp);
presc.status='dispensed';
localStorage.setItem('prescriptions',JSON.stringify(prescriptions));
localStorage.setItem('dispensed',JSON.stringify(dispensed));
console.log('💊 Patient ID:', presc.patientId);
console.log('💊 All appointments BEFORE dispense:', appointments.map(a=>({name:a.patientName,id:a.patientId,status:a.status})));
const appt=appointments.find(a=>a.patientId===presc.patientId&&a.status==='payment-done');
if(appt){
appt.status='medication-ready';
localStorage.setItem('appointments',JSON.stringify(appointments));
console.log('✅ DISPENSE SUCCESS - Status updated to medication-ready');
console.log('✅ Updated appointment:', appt);
}else{
console.log('❌ DISPENSE FAILED - No payment-done appointment found');
console.log('❌ Available appointments:', appointments.filter(a=>a.patientId===presc.patientId));
}
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
console.log('💊 All appointments AFTER dispense:', appointments.map(a=>({name:a.patientName,id:a.patientId,status:a.status})));
sendMessage('receptionist',presc.patientName,`✅ Medication ready: ${presc.medication}. Patient can checkout.`,'dispensed');
showAlert('Medication dispensed!');
showToast('Medication Ready',`${presc.medication} ready`);
closeModal('dispenseMedModal');
e.target.reset();
loadPharmacyData();
loadAllAppointments();
populateDropdowns();
}
}

function processRefill(e){
e.preventDefault();
showAlert('Refill processed!');
closeModal('refillModal');
e.target.reset();
}

function collectCopay(e){
e.preventDefault();
const patientId=document.getElementById('copayPatient').value;
const patient=patients.find(p=>p.id===patientId);
const amount=parseFloat(document.getElementById('copayAmount').value);
const copay={id:'CP'+Date.now(),patientId:patientId,patientName:`${patient.firstName} ${patient.lastName}`,amount:amount,method:document.getElementById('copayMethod').value,collectedBy:currentUser.name,createdAt:new Date().toISOString()};
billing.push(copay);
localStorage.setItem('billing',JSON.stringify(billing));
accountBalance+=amount;
localStorage.setItem('accountBalance',accountBalance.toString());
addTransaction('deposit',amount,`Copay from ${copay.patientName}`);
showAlert('Copay collected!');
closeModal('copayModal');
e.target.reset();
updateDashboard();
updateFinancialDisplay();
}

function submitClaim(e){
e.preventDefault();
const patientId=document.getElementById('claimPatient').value;
const patient=patients.find(p=>p.id===patientId);
const claim={id:'CL'+Date.now(),patientId:patientId,patientName:`${patient.firstName} ${patient.lastName}`,cpt:document.getElementById('claimCPT').value,icd:document.getElementById('claimICD').value,amount:parseFloat(document.getElementById('claimAmount').value),status:'submitted',submittedBy:currentUser.name,createdAt:new Date().toISOString()};
billing.push(claim);
localStorage.setItem('billing',JSON.stringify(billing));
showAlert('Claim submitted!');
closeModal('claimModal');
e.target.reset();
updateDashboard();
}

function registerUser(e){
e.preventDefault();
const email=document.getElementById('newUserEmail').value;
if(users.find(u=>u.email===email)){alert('❌ Email exists!');return;}
const user={id:'U'+Date.now(),name:document.getElementById('newUserName').value,email:email,password:document.getElementById('newUserPassword').value,role:document.getElementById('newUserRole').value};
users.push(user);
localStorage.setItem('users',JSON.stringify(users));
showAlert('User registered!');
closeModal('registerUserModal');
e.target.reset();
loadUsers();
}

function loadPatients(){
const tbody=document.getElementById('patientsList');
tbody.innerHTML=patients.map(p=>`<tr><td>${p.id}</td><td>${p.firstName} ${p.lastName}</td><td>${p.dob}</td><td>${p.medicareID}</td><td><span class="badge badge-success">${p.status}</span></td><td><button class="btn btn-sm btn-primary" onclick="viewPatient('${p.id}')"><i class="fas fa-eye"></i></button>${currentUser.role==='admin'?`<button class="btn btn-sm btn-danger" onclick="deletePatient('${p.id}')"><i class="fas fa-trash"></i></button>`:''}</td></tr>`).join('')||'<tr><td colspan="6" style="text-align:center;padding:30px;">No patients</td></tr>';
}

function viewPatient(id){
const p=patients.find(pt=>pt.id===id);
if(p)alert(`Patient: ${p.firstName} ${p.lastName}\nDOB: ${p.dob}\nMedicare ID: ${p.medicareID}\nPhone: ${p.phone}\nBlood: ${p.bloodGroup}\nInsurance: ${p.insurance}\nAddress: ${p.address}`);
}

function deletePatient(id){
if(confirm('Delete patient?')){
patients=patients.filter(p=>p.id!==id);
localStorage.setItem('patients',JSON.stringify(patients));
showAlert('Patient deleted!');
loadPatients();
updateDashboard();
}
}

function loadAllAppointments(){
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
const active=appointments.filter(a=>a.status!=='completed');
const div=document.getElementById('allAppointments');
div.innerHTML=active.map(a=>`<div class="task-card"><div class="task-header"><h4>${a.patientName}</h4><span class="badge badge-${a.status==='scheduled'?'info':a.status==='checked-in'?'warning':a.status==='vitals-done'?'primary':a.status==='exam-done'?'danger':a.status==='payment-done'?'success':a.status==='medication-ready'?'success':'info'}">${a.status}</span></div><div class="task-body"><div class="task-item"><label>Date</label><span>${a.date}</span></div><div class="task-item"><label>Time</label><span>${a.time}</span></div><div class="task-item"><label>Doctor</label><span>${a.doctor}</span></div><div class="task-item"><label>Reason</label><span>${a.reason}</span></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No active appointments</p>';
}

function loadPatientsForVitals(){
const ready=appointments.filter(a=>a.status==='checked-in');
const div=document.getElementById('patientsForVitals');
div.innerHTML=ready.map(a=>`<div class="task-card"><div class="task-header"><h4>${a.patientName}</h4><span class="badge badge-warning">Waiting</span></div><div class="task-body"><div class="task-item"><label>Time</label><span>${a.time}</span></div><div class="task-item"><label>Doctor</label><span>${a.doctor}</span></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No patients waiting</p>';
}

function loadPatientsForDoctor(){
const ready=appointments.filter(a=>a.status==='vitals-done');
const div=document.getElementById('patientsForDoctor');
div.innerHTML=ready.map(a=>{
const v=vitals.find(vt=>vt.patientId===a.patientId);
return`<div class="task-card"><div class="task-header"><h4>${a.patientName}</h4><span class="badge badge-success">Ready</span></div><div class="task-body">${v?`<div class="task-item"><label>BP</label><span>${v.bp}</span></div><div class="task-item"><label>Temp</label><span>${v.temp}°F</span></div><div class="task-item"><label>HR</label><span>${v.hr} bpm</span></div><div class="task-item"><label>Weight</label><span>${v.weight} lbs</span></div>`:''}</div></div>`;
}).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No patients ready</p>';
}

function loadPharmacyData(){
prescriptions=JSON.parse(localStorage.getItem('prescriptions')||'[]');
dispensed=JSON.parse(localStorage.getItem('dispensed')||'[]');
const pending=prescriptions.filter(p=>p.status==='pending');
const div=document.getElementById('pendingPrescriptions');
div.innerHTML=pending.map(p=>`<div class="prescription-card"><div class="prescription-header"><div><h4>${p.medication}</h4><p style="color:var(--text-secondary);margin:0;font-size:.9em;"><i class="fas fa-user"></i> ${p.patientName} | <i class="fas fa-user-md"></i> ${p.doctor}</p></div><span class="badge badge-warning">Pending</span></div><div class="prescription-body"><div class="prescription-item"><i class="fas fa-pills"></i><div class="prescription-item-content"><strong>Dosage</strong><span>${p.dosage}</span></div></div><div class="prescription-item"><i class="fas fa-clock"></i><div class="prescription-item-content"><strong>Frequency</strong><span>${p.frequency}</span></div></div><div class="prescription-item"><i class="fas fa-calendar-alt"></i><div class="prescription-item-content"><strong>Duration</strong><span>${p.duration}</span></div></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No pending prescriptions</p>';
const dispDiv=document.getElementById('dispensedMedications');
dispDiv.innerHTML=dispensed.slice(-10).reverse().map(d=>`<div class="task-card"><div class="task-header"><h4>${d.medication}</h4><span class="badge badge-success">Dispensed</span></div><div class="task-body"><div class="task-item"><label>Patient</label><span>${d.patientName}</span></div><div class="task-item"><label>Quantity</label><span>${d.quantity}</span></div><div class="task-item"><label>Date</label><span>${new Date(d.dispensedAt).toLocaleDateString()}</span></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No medications dispensed</p>';
}

function loadPendingBilling(){
const pending=appointments.filter(a=>a.status==='exam-done');
const div=document.getElementById('pendingBilling');
div.innerHTML=pending.map(a=>`<div class="task-card"><div class="task-header"><h4>${a.patientName}</h4><span class="badge badge-warning">Pending</span></div><div class="task-body"><div class="task-item"><label>Date</label><span>${a.date}</span></div><div class="task-item"><label>Doctor</label><span>${a.doctor}</span></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No pending billing</p>';
}

function loadUsers(){
const tbody=document.getElementById('usersList');
tbody.innerHTML=users.map(u=>`<tr><td>${u.name}</td><td>${u.email}</td><td><span class="role-badge role-${u.role}">${u.role}</span></td><td>${currentUser.role==='admin'&&u.id!==currentUser.id?`<button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')"><i class="fas fa-trash"></i></button>`:'-'}</td></tr>`).join('');
}

function deleteUser(id){
if(confirm('Delete user?')){
users=users.filter(u=>u.id!==id);
localStorage.setItem('users',JSON.stringify(users));
showAlert('User deleted!');
loadUsers();
}
}

function populateDropdowns(){
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
prescriptions=JSON.parse(localStorage.getItem('prescriptions')||'[]');
patients=JSON.parse(localStorage.getItem('patients')||'[]');
console.log('📋 Populating dropdowns');
console.log('📋 Medication-ready count:', appointments.filter(a=>a.status==='medication-ready').length);
const selects=['schedPatient','checkInAppt','vitalPatient','historyPatient','examPatient','prescPatient','labPatient','copayPatient','claimPatient','checkOutPatient','dispensePrescription','refillPatient'];
selects.forEach(id=>{
const sel=document.getElementById(id);
if(sel){
if(id==='checkInAppt'){
const scheduled=appointments.filter(a=>a.status==='scheduled');
sel.innerHTML='<option value="">Select Appointment</option>'+scheduled.map(a=>`<option value="${a.id}">${a.date} ${a.time} - ${a.patientName}</option>`).join('');
if(scheduled.length===0){sel.innerHTML='<option value="">No scheduled appointments</option>';}
}else if(id==='checkOutPatient'){
const ready=appointments.filter(a=>a.status==='medication-ready');
sel.innerHTML='<option value="">Select Patient</option>'+ready.map(a=>`<option value="${a.patientId}">${a.patientName} - Ready</option>`).join('');
if(ready.length===0){sel.innerHTML='<option value="">No patients ready for checkout</option>';}
console.log('✅ Checkout dropdown:', ready.length, 'patients');
}else if(id==='dispensePrescription'){
const pending=prescriptions.filter(p=>p.status==='pending');
sel.innerHTML='<option value="">Select Prescription</option>'+pending.map(p=>`<option value="${p.id}">${p.patientName} - ${p.medication}</option>`).join('');
if(pending.length===0){sel.innerHTML='<option value="">No pending prescriptions</option>';}
}else{
sel.innerHTML='<option value="">Select Patient</option>'+patients.map(p=>`<option value="${p.id}">${p.firstName} ${p.lastName}</option>`).join('');
}
}
});
}

function updateDashboard(){
document.getElementById('totalPatients').textContent=patients.length;
const active=appointments.filter(a=>a.status!=='completed').length;
document.getElementById('activeAppointments').textContent=active;
document.getElementById('pendingTasks').textContent=active;
document.getElementById('totalRevenue').textContent='$'+accountBalance.toFixed(2);
const div=document.getElementById('activeAppointmentsList');
const activeAppts=appointments.filter(a=>a.status!=='completed');
div.innerHTML=activeAppts.map(a=>`<div class="task-card"><div class="task-header"><h4>${a.patientName}</h4><span class="badge badge-${a.status==='scheduled'?'info':a.status==='checked-in'?'warning':a.status==='vitals-done'?'primary':a.status==='exam-done'?'danger':a.status==='payment-done'?'success':a.status==='medication-ready'?'success':'info'}">${a.status}</span></div><div class="task-body"><div class="task-item"><label>Date</label><span>${a.date}</span></div><div class="task-item"><label>Time</label><span>${a.time}</span></div><div class="task-item"><label>Doctor</label><span>${a.doctor}</span></div></div></div>`).join('')||'<p style="text-align:center;color:var(--text-secondary);padding:20px;">No active appointments</p>';
}

function debugAppointments(){
appointments=JSON.parse(localStorage.getItem('appointments')||'[]');
const statusCounts={};
appointments.forEach(a=>{statusCounts[a.status]=(statusCounts[a.status]||0)+1;});
const report=`📊 APPOINTMENT STATUS REPORT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Total: ${appointments.length}

Status Breakdown:
${Object.keys(statusCounts).map(s=>`  • ${s}: ${statusCounts[s]}`).join('\n')}

Medication-Ready:
${appointments.filter(a=>a.status==='medication-ready').map(a=>`  ✅ ${a.patientName} (${a.patientId})`).join('\n') || '  None'}

All Appointments:
${appointments.map(a=>`  • ${a.patientName}: ${a.status}`).join('\n') || '  None'}`;
alert(report);
console.log(report);
}

// DATABASE VIEWER FUNCTIONS
function showDbTab(tab){
document.querySelectorAll('.db-tab').forEach(t=>t.classList.remove('active'));
event.target.classList.add('active');
const content=document.getElementById('dbTabContent');
switch(tab){
case 'diagram':content.innerHTML=generateERDiagram();break;
case 'tables':content.innerHTML=generateDataTables();break;
case 'relationships':content.innerHTML=generateRelationships();break;
case 'flow':content.innerHTML=generateDataFlow();break;
case 'query':content.innerHTML=generateQueryConsole();break;
case 'stats':content.innerHTML=generateStatistics();break;
}
}

function generateERDiagram(){
return`<div class="db-diagram"><h3 style="color:var(--primary);margin-bottom:20px;"><i class="fas fa-project-diagram"></i> Entity-Relationship Diagram</h3><div class="er-diagram">┌─────────────────────────────────────────────────────────────────────────┐
│                         LOCALSTORAGE DATABASE                            │
│                    (Browser-based Key-Value Store)                       │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────┐
│    PATIENTS      │ ◄─────────┐
├──────────────────┤           │
│ 🔑 id (PK)       │           │
│ firstName        │           │
│ lastName         │           │
│ dob              │           │
│ medicareID       │           │
│ phone            │           │
│ bloodGroup       │           │
│ address          │           │
│ insurance        │           │
│ status           │           │
│ createdAt        │           │
└──────────────────┘           │
                               │ (1:N)
                               │
┌──────────────────┐           │
│  APPOINTMENTS    │           │
├──────────────────┤           │
│ 🔑 id (PK)       │           │
│ 🔗 patientId(FK) │───────────┘
│ patientName      │
│ doctor           │
│ date             │
│ time             │
│ reason           │
│ status           │ ◄── STATUS FLOW:
│ coverage         │     1. scheduled
│ copay            │     2. checked-in
│ 🔗 paymentId(FK) │     3. vitals-done
│ paymentStatus    │     4. exam-done
│ createdAt        │     5. payment-done
└──────────────────┘     6. medication-ready
       │                 7. archived
       │
       ├─────────────────────────────────────┐
       │                                     │
       ▼ (1:1)                               ▼ (1:1)
┌──────────────────┐              ┌──────────────────┐
│     VITALS       │              │      EXAMS       │
├──────────────────┤              ├──────────────────┤
│ 🔑 id (PK)       │              │ 🔑 id (PK)       │
│ 🔗 patientId(FK) │              │ 🔗 patientId(FK) │
│ patientName      │              │ patientName      │
│ bp               │              │ findings         │
│ temp             │              │ diagnosis        │
│ hr               │              │ treatment        │
│ weight           │              │ fee              │
│ o2               │              │ doctor           │
│ recordedBy       │              │ createdAt        │
│ recordedAt       │              └──────────────────┘
└──────────────────┘                       │
                                           │ (1:1)
                                           ▼
                                ┌──────────────────┐
                                │  PRESCRIPTIONS   │
                                ├──────────────────┤
                                │ 🔑 id (PK)       │
                                │ 🔗 patientId(FK) │
                                │ patientName      │
                                │ medication       │
                                │ dosage           │
                                │ frequency        │
                                │ duration         │
                                │ coverage         │
                                │ doctor           │
                                │ status           │
                                │ createdAt        │
                                └──────────────────┘
                                         │ (1:1)
                                         ▼
                                ┌──────────────────┐
                                │    DISPENSED     │
                                ├──────────────────┤
                                │ 🔑 id (PK)       │
                                │ 🔗 prescId(FK)   │
                                │ 🔗 patientId(FK) │
                                │ patientName      │
                                │ medication       │
                                │ dosage           │
                                │ quantity         │
                                │ instructions     │
                                │ dispensedBy      │
                                │ dispensedAt      │
                                └──────────────────┘

┌──────────────────┐
│    PAYMENTS      │
├──────────────────┤
│ 🔑 id (PK)       │
│ 🔗 patientId(FK) │
│ patientName      │
│ amount           │
│ service          │
│ method           │
│ status           │
│ processedBy      │
│ createdAt        │
└──────────────────┘

┌──────────────────┐
│    ARCHIVES      │
├──────────────────┤
│ 🔑 id (PK)       │
│ 🔗 apptId(FK)    │
│ 🔗 patientId(FK) │
│ patientName      │
│ doctor           │
│ date, time       │
│ diagnosis        │
│ medication       │
│ archivedAt       │
│ archivedBy       │
└──────────────────┘

┌──────────────────┐
│     USERS        │
├──────────────────┤
│ 🔑 id (PK)       │
│ name             │
│ email            │
│ password         │
│ role             │
└──────────────────┘

┌──────────────────┐
│    MESSAGES      │
├──────────────────┤
│ 🔑 id (PK)       │
│ from, to         │
│ patientName      │
│ message          │
│ type             │
│ read             │
│ createdAt        │
└──────────────────┘

┌──────────────────┐
│  TRANSACTIONS    │
├──────────────────┤
│ 🔑 id (PK)       │
│ type             │
│ amount           │
│ description      │
│ balance          │
│ createdBy        │
│ createdAt        │
└──────────────────┘

Legend:
🔑 = Primary Key
🔗 = Foreign Key
(1:1) = One-to-One Relationship
(1:N) = One-to-Many Relationship</div><div style="margin-top:30px;padding:20px;background:var(--bg-primary);border-radius:12px;"><h4 style="color:var(--primary);margin-bottom:15px;">Database Storage Location</h4><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Storage Type:</strong> Browser localStorage (Client-side)</p><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Storage Path:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">localStorage['table_name']</code></p><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Data Format:</strong> JSON (JavaScript Object Notation)</p><p style="color:var(--text-secondary);"><strong>Max Storage:</strong> ~5-10MB per domain (browser dependent)</p></div></div>`;
}

function generateDataTables(){
const tables={
patients:{icon:'user-injured',color:'primary'},
appointments:{icon:'calendar-check',color:'info'},
vitals:{icon:'heartbeat',color:'danger'},
exams:{icon:'stethoscope',color:'success'},
prescriptions:{icon:'prescription',color:'warning'},
dispensed:{icon:'pills',color:'success'},
payments:{icon:'dollar-sign',color:'success'},
archives:{icon:'archive',color:'info'},
users:{icon:'users-cog',color:'primary'},
messages:{icon:'envelope',color:'warning'},
transactions:{icon:'exchange-alt',color:'success'},
labs:{icon:'flask',color:'info'},
inventory:{icon:'boxes',color:'warning'},
billing:{icon:'file-invoice-dollar',color:'success'}
};
let html='<div class="db-table-container">';
for(let[tableName,config]of Object.entries(tables)){
const data=window[tableName]||[];
const schema=getTableSchema(tableName);
html+=`<div class="db-table-card"><h3><i class="fas fa-${config.icon}" style="color:var(--${config.color});"></i> ${tableName.toUpperCase()}<span class="record-count">${data.length}</span></h3><div style="margin-bottom:15px;">${schema.map(field=>`<div class="db-field ${field.key||''}"><span class="db-field-name">${field.name}</span><span class="db-field-type">${field.type}</span></div>`).join('')}</div><button class="btn btn-sm btn-primary" onclick="viewTableData('${tableName}')"><i class="fas fa-eye"></i> View Data</button> <button class="btn btn-sm btn-info" onclick="exportTableData('${tableName}')"><i class="fas fa-download"></i> Export JSON</button></div>`;
}
html+='</div>';
html+='<div id="tableDataViewer"></div>';
return html;
}

function getTableSchema(tableName){
const schemas={
patients:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'firstName',type:'String'},
{name:'lastName',type:'String'},
{name:'dob',type:'Date'},
{name:'medicareID',type:'String'},
{name:'phone',type:'String'},
{name:'bloodGroup',type:'String'},
{name:'address',type:'String'},
{name:'insurance',type:'String'},
{name:'status',type:'String'},
{name:'createdAt',type:'DateTime'}
],
appointments:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'patientId',type:'String (FK)',key:'foreign-key'},
{name:'patientName',type:'String'},
{name:'doctor',type:'String'},
{name:'date',type:'Date'},
{name:'time',type:'Time'},
{name:'reason',type:'String'},
{name:'status',type:'Enum'},
{name:'coverage',type:'String'},
{name:'paymentId',type:'String (FK)',key:'foreign-key'},
{name:'createdAt',type:'DateTime'}
],
vitals:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'patientId',type:'String (FK)',key:'foreign-key'},
{name:'patientName',type:'String'},
{name:'bp',type:'String'},
{name:'temp',type:'String'},
{name:'hr',type:'Number'},
{name:'weight',type:'Number'},
{name:'o2',type:'Number'},
{name:'recordedBy',type:'String'},
{name:'recordedAt',type:'DateTime'}
],
exams:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'patientId',type:'String (FK)',key:'foreign-key'},
{name:'patientName',type:'String'},
{name:'findings',type:'Text'},
{name:'diagnosis',type:'String'},
{name:'treatment',type:'Text'},
{name:'fee',type:'Number'},
{name:'doctor',type:'String'},
{name:'createdAt',type:'DateTime'}
],
prescriptions:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'patientId',type:'String (FK)',key:'foreign-key'},
{name:'patientName',type:'String'},
{name:'medication',type:'String'},
{name:'dosage',type:'String'},
{name:'frequency',type:'String'},
{name:'duration',type:'String'},
{name:'coverage',type:'String'},
{name:'doctor',type:'String'},
{name:'status',type:'Enum'},
{name:'createdAt',type:'DateTime'}
],
dispensed:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'prescriptionId',type:'String (FK)',key:'foreign-key'},
{name:'patientId',type:'String (FK)',key:'foreign-key'},
{name:'patientName',type:'String'},
{name:'medication',type:'String'},
{name:'dosage',type:'String'},
{name:'quantity',type:'Number'},
{name:'instructions',type:'Text'},
{name:'dispensedBy',type:'String'},
{name:'dispensedAt',type:'DateTime'}
],
payments:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'patientId',type:'String (FK)',key:'foreign-key'},
{name:'patientName',type:'String'},
{name:'amount',type:'Number'},
{name:'service',type:'String'},
{name:'method',type:'String'},
{name:'status',type:'String'},
{name:'processedBy',type:'String'},
{name:'createdAt',type:'DateTime'}
],
archives:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'appointmentId',type:'String (FK)',key:'foreign-key'},
{name:'patientId',type:'String (FK)',key:'foreign-key'},
{name:'patientName',type:'String'},
{name:'doctor',type:'String'},
{name:'date',type:'Date'},
{name:'diagnosis',type:'String'},
{name:'medication',type:'String'},
{name:'archivedAt',type:'DateTime'},
{name:'archivedBy',type:'String'},
{name:'type',type:'String'}
],
users:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'name',type:'String'},
{name:'email',type:'String'},
{name:'password',type:'String'},
{name:'role',type:'Enum'}
],
messages:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'from',type:'String'},
{name:'fromName',type:'String'},
{name:'to',type:'String'},
{name:'patientName',type:'String'},
{name:'message',type:'Text'},
{name:'type',type:'String'},
{name:'read',type:'Boolean'},
{name:'createdAt',type:'DateTime'}
],
transactions:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'type',type:'Enum'},
{name:'amount',type:'Number'},
{name:'description',type:'String'},
{name:'balance',type:'Number'},
{name:'createdBy',type:'String'},
{name:'createdAt',type:'DateTime'}
],
labs:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'patientId',type:'String (FK)',key:'foreign-key'},
{name:'patientName',type:'String'},
{name:'test',type:'String'},
{name:'priority',type:'String'},
{name:'notes',type:'Text'},
{name:'orderedBy',type:'String'},
{name:'status',type:'String'},
{name:'createdAt',type:'DateTime'}
],
inventory:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'medication',type:'String'},
{name:'quantity',type:'Number'},
{name:'price',type:'Number'},
{name:'expiry',type:'Date'},
{name:'batch',type:'String'},
{name:'addedBy',type:'String'},
{name:'createdAt',type:'DateTime'}
],
billing:[
{name:'id',type:'String (PK)',key:'primary-key'},
{name:'patientId',type:'String (FK)',key:'foreign-key'},
{name:'patientName',type:'String'},
{name:'amount',type:'Number'},
{name:'method',type:'String'},
{name:'collectedBy',type:'String'},
{name:'createdAt',type:'DateTime'}
]
};
return schemas[tableName]||[];
}

function viewTableData(tableName){
const data=window[tableName]||[];
const viewer=document.getElementById('tableDataViewer');
if(data.length===0){
viewer.innerHTML=`<div style="margin-top:20px;padding:30px;background:var(--bg-secondary);border-radius:12px;text-align:center;"><i class="fas fa-inbox" style="font-size:3em;color:var(--text-secondary);margin-bottom:15px;"></i><p style="color:var(--text-secondary);">No data in ${tableName} table</p></div>`;
return;
}
const keys=Object.keys(data[0]);
viewer.innerHTML=`<div style="margin-top:30px;"><h3 style="color:var(--primary);margin-bottom:15px;"><i class="fas fa-table"></i> ${tableName.toUpperCase()} - Live Data (${data.length} records)</h3><div class="data-table-viewer"><table><thead><tr>${keys.map(k=>`<th>${k}</th>`).join('')}</tr></thead><tbody>${data.map(row=>`<tr>${keys.map(k=>`<td>${JSON.stringify(row[k])||'null'}</td>`).join('')}</tr>`).join('')}</tbody></table></div></div>`;
}

function exportTableData(tableName){
const data=window[tableName]||[];
const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download=`${tableName}-${new Date().toISOString().split('T')[0]}.json`;
a.click();
URL.revokeObjectURL(url);
showAlert(`${tableName} data exported successfully!`);
}

function generateRelationships(){
return`<div class="relationship-diagram"><h3 style="color:var(--primary);margin-bottom:20px;"><i class="fas fa-link"></i> Database Relationships</h3><div class="relationship-card"><h4><i class="fas fa-arrow-right"></i> PATIENTS → APPOINTMENTS (One-to-Many)</h4><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Type:</strong> One patient can have multiple appointments</p><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Foreign Key:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">appointments.patientId → patients.id</code></p><p style="color:var(--text-secondary);"><strong>JavaScript:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">appointments.filter(a => a.patientId === patient.id)</code></p></div><div class="relationship-card"><h4><i class="fas fa-arrow-right"></i> APPOINTMENTS → VITALS (One-to-One)</h4><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Type:</strong> Each appointment has one vitals record</p><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Foreign Key:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">vitals.patientId → appointments.patientId</code></p><p style="color:var(--text-secondary);"><strong>JavaScript:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">vitals.find(v => v.patientId === appointment.patientId)</code></p></div><div class="relationship-card"><h4><i class="fas fa-arrow-right"></i> APPOINTMENTS → EXAMS (One-to-One)</h4><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Type:</strong> Each appointment has one exam record</p><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Foreign Key:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">exams.patientId → appointments.patientId</code></p><p style="color:var(--text-secondary);"><strong>JavaScript:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">exams.find(e => e.patientId === appointment.patientId)</code></p></div><div class="relationship-card"><h4><i class="fas fa-arrow-right"></i> EXAMS → PRESCRIPTIONS (One-to-One)</h4><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Type:</strong> Each exam can have one prescription</p><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Foreign Key:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">prescriptions.patientId → exams.patientId</code></p><p style="color:var(--text-secondary);"><strong>JavaScript:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">prescriptions.find(p => p.patientId === exam.patientId)</code></p></div><div class="relationship-card"><h4><i class="fas fa-arrow-right"></i> PRESCRIPTIONS → DISPENSED (One-to-One)</h4><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Type:</strong> Each prescription has one dispensed record</p><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Foreign Key:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">dispensed.prescriptionId → prescriptions.id</code></p><p style="color:var(--text-secondary);"><strong>JavaScript:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">dispensed.find(d => d.prescriptionId === prescription.id)</code></p></div><div class="relationship-card"><h4><i class="fas fa-arrow-right"></i> APPOINTMENTS → PAYMENTS (One-to-One)</h4><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Type:</strong> Each appointment has one payment record</p><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Foreign Key:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">payments.patientId → appointments.patientId</code></p><p style="color:var(--text-secondary);"><strong>JavaScript:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">payments.find(p => p.patientId === appointment.patientId)</code></p></div><div class="relationship-card"><h4><i class="fas fa-arrow-right"></i> APPOINTMENTS → ARCHIVES (One-to-One)</h4><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Type:</strong> Completed appointments are archived</p><p style="color:var(--text-secondary);margin-bottom:10px;"><strong>Foreign Key:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">archives.appointmentId → appointments.id</code></p><p style="color:var(--text-secondary);"><strong>JavaScript:</strong> <code style="background:var(--bg-secondary);padding:4px 8px;border-radius:4px;">archives.find(a => a.appointmentId === appointment.id)</code></p></div></div>`;
}

function generateDataFlow(){
return`<div style="padding:20px;"><h3 style="color:var(--primary);margin-bottom:20px;"><i class="fas fa-stream"></i> Complete Data Flow</h3><div class="flow-step"><h4><i class="fas fa-user-plus"></i> Step 1: Register Patient</h4><p style="color:var(--text-secondary);margin-bottom:10px;">User fills registration form → JavaScript captures data → Creates patient object → Saves to localStorage</p><code>// Form Submission
function addPatient(e) {
    e.preventDefault();
    
    // COLLECT: Get form data
    const patient = {
        id: 'P' + Date.now(),
        firstName: document.getElementById('patFirstName').value,
        lastName: document.getElementById('patLastName').value,
        // ... other fields
    };
    
    // WRITE: Add to array
    patients.push(patient);
    
    // SAVE: Store in database
    localStorage.setItem('patients', JSON.stringify(patients));
}</code></div><div class="flow-step"><h4><i class="fas fa-calendar-plus"></i> Step 2: Schedule Appointment</h4><p style="color:var(--text-secondary);margin-bottom:10px;">Read patient from database → Create appointment → Link via patientId → Save to localStorage</p><code>// READ: Get patient
const patient = patients.find(p => p.id === patientId);

// CREATE: New appointment
const appt = {
    id: 'A' + Date.now(),
    patientId: patient.id,  // ← Foreign Key
    patientName: patient.firstName + ' ' + patient.lastName,
    status: 'scheduled',
    // ... other fields
};

// WRITE: Save appointment
appointments.push(appt);
localStorage.setItem('appointments', JSON.stringify(appointments));</code></div><div class="flow-step"><h4><i class="fas fa-sign-in-alt"></i> Step 3: Check-In Patient</h4><p style="color:var(--text-secondary);margin-bottom:10px;">Find appointment by ID → Update status → Save changes</p><code>// READ: Find appointment
const appt = appointments.find(a => a.id === apptId);

// UPDATE: Change status
appt.status = 'checked-in';

// WRITE: Save changes
localStorage.setItem('appointments', JSON.stringify(appointments));</code></div><div class="flow-step"><h4><i class="fas fa-heartbeat"></i> Step 4: Record Vitals</h4><p style="color:var(--text-secondary);margin-bottom:10px;">Create vitals record → Link to patient → Update appointment status</p><code>// CREATE: New vitals record
const vital = {
    id: 'V' + Date.now(),
    patientId: patientId,  // ← Foreign Key
    bp: '120/80',
    temp: '98.6',
    // ... other vitals
};

// WRITE: Save vitals
vitals.push(vital);
localStorage.setItem('vitals', JSON.stringify(vitals));

// UPDATE: Appointment status
const appt = appointments.find(a => a.patientId === patientId);
appt.status = 'vitals-done';
localStorage.setItem('appointments', JSON.stringify(appointments));</code></div><div class="flow-step"><h4><i class="fas fa-stethoscope"></i> Step 5: Document Exam</h4><p style="color:var(--text-secondary);margin-bottom:10px;">Create exam record → Update appointment status → Trigger payment workflow</p><code>// CREATE: Exam record
const exam = {
    id: 'E' + Date.now(),
    patientId: patientId,  // ← Foreign Key
    diagnosis: 'Hypertension',
    fee: 150.00,
    // ... other fields
};

// WRITE: Save exam
exams.push(exam);
localStorage.setItem('exams', JSON.stringify(exams));

// UPDATE: Appointment status
appt.status = 'exam-done';
localStorage.setItem('appointments', JSON.stringify(appointments));</code></div><div class="flow-step"><h4><i class="fas fa-credit-card"></i> Step 6: Process Payment</h4><p style="color:var(--text-secondary);margin-bottom:10px;">Create payment record → Update account balance → Update appointment status</p><code>// RELOAD: Fresh data (CRITICAL!)
appointments = JSON.parse(localStorage.getItem('appointments') || '[]');

// CREATE: Payment record
const payment = {
    id: 'PAY' + Date.now(),
    patientId: patientId,  // ← Foreign Key
    amount: 150.00,
    status: 'paid',
    // ... other fields
};

// WRITE: Save payment
payments.push(payment);
localStorage.setItem('payments', JSON.stringify(payments));

// UPDATE: Account balance
accountBalance += payment.amount;
localStorage.setItem('accountBalance', accountBalance.toString());

// UPDATE: Appointment status
const appt = appointments.find(a => a.patientId === patientId);
appt.status = 'payment-done';
appt.paymentId = payment.id;  // ← Link payment
localStorage.setItem('appointments', JSON.stringify(appointments));</code></div><div class="flow-step"><h4><i class="fas fa-pills"></i> Step 7: Dispense Medication</h4><p style="color:var(--text-secondary);margin-bottom:10px;">Find prescription → Create dispensed record → Update appointment status</p><code>// RELOAD: Fresh data
prescriptions = JSON.parse(localStorage.getItem('prescriptions') || '[]');
appointments = JSON.parse(localStorage.getItem('appointments') || '[]');

// READ: Get prescription
const presc = prescriptions.find(p => p.id === prescId);

// CREATE: Dispensed record
const disp = {
    id: 'DISP' + Date.now(),
    prescriptionId: presc.id,  // ← Foreign Key
    patientId: presc.patientId,  // ← Foreign Key
    medication: presc.medication,
    // ... other fields
};

// WRITE: Save dispensed
dispensed.push(disp);
localStorage.setItem('dispensed', JSON.stringify(dispensed));

// UPDATE: Prescription status
presc.status = 'dispensed';
localStorage.setItem('prescriptions', JSON.stringify(prescriptions));

// UPDATE: Appointment status
const appt = appointments.find(a => a.patientId === presc.patientId);
appt.status = 'medication-ready';
localStorage.setItem('appointments', JSON.stringify(appointments));</code></div><div class="flow-step"><h4><i class="fas fa-sign-out-alt"></i> Step 8: Check-Out & Archive</h4><p style="color:var(--text-secondary);margin-bottom:10px;">Combine all related data → Create archive record → Remove from active appointments</p><code>// RELOAD: All related data
appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
exams = JSON.parse(localStorage.getItem('exams') || '[]');
prescriptions = JSON.parse(localStorage.getItem('prescriptions') || '[]');

// READ: Find appointment
const appt = appointments.find(a => 
    a.patientId === patientId && 
    a.status === 'medication-ready'
);

// READ: Get related records (JOIN-like operation)
const exam = exams.find(e => e.patientId === patientId);
const presc = prescriptions.find(p => p.patientId === patientId);

// CREATE: Archive (combines all data)
const archive = {
    id: 'ARC' + Date.now(),
    appointmentId: appt.id,  // ← Foreign Key
    patientId: appt.patientId,  // ← Foreign Key
    patientName: appt.patientName,
    diagnosis: exam ? exam.diagnosis : 'N/A',
    medication: presc ? presc.medication : 'N/A',
    // ... combined data from all tables
};

// WRITE: Save archive
archives.push(archive);
localStorage.setItem('archives', JSON.stringify(archives));

// DELETE: Remove from active appointments
appointments = appointments.filter(a => a.id !== appt.id);
localStorage.setItem('appointments', JSON.stringify(appointments));</code></div><div style="margin-top:30px;padding:20px;background:var(--bg-primary);border-radius:12px;"><h4 style="color:var(--primary);margin-bottom:15px;">Key Principles</h4><ul style="color:var(--text-secondary);line-height:1.8;"><li><strong>Always reload before critical operations:</strong> <code>appointments = JSON.parse(localStorage.getItem('appointments') || '[]')</code></li><li><strong>Save after every modification:</strong> <code>localStorage.setItem('appointments', JSON.stringify(appointments))</code></li><li><strong>Use unique IDs:</strong> <code>id: 'P' + Date.now()</code></li><li><strong>Link records via Foreign Keys:</strong> <code>patientId, appointmentId, prescriptionId</code></li><li><strong>Update UI after database changes:</strong> <code>loadAllAppointments()</code></li></ul></div></div>`;
}

function generateQueryConsole(){
return`<div class="query-console"><h3 style="color:var(--primary);margin-bottom:20px;"><i class="fas fa-terminal"></i> JavaScript Query Console</h3><p style="color:var(--text-secondary);margin-bottom:15px;">Execute JavaScript queries on the database. Examples: <code>patients.filter(p => p.bloodGroup === 'O+')</code></p><textarea class="query-input" id="queryInput" placeholder="Enter JavaScript query here...
Examples:
- patients.filter(p => p.bloodGroup === 'O+')
- appointments.filter(a => a.status === 'scheduled')
- exams.map(e => ({ patient: e.patientName, diagnosis: e.diagnosis }))
- payments.reduce((sum, p) => sum + p.amount, 0)"></textarea><button class="btn btn-primary" onclick="executeQuery()"><i class="fas fa-play"></i> Execute Query</button> <button class="btn btn-secondary" onclick="clearQueryResult()"><i class="fas fa-eraser"></i> Clear</button><div id="queryResult"></div><div style="margin-top:30px;padding:20px;background:var(--bg-primary);border-radius:12px;"><h4 style="color:var(--primary);margin-bottom:15px;">Quick Queries</h4><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px;"><button class="btn btn-sm btn-info" onclick="runQuickQuery('patients')">All Patients</button><button class="btn btn-sm btn-info" onclick="runQuickQuery('appointments')">All Appointments</button><button class="btn btn-sm btn-info" onclick="runQuickQuery('scheduled')">Scheduled Appointments</button><button class="btn btn-sm btn-info" onclick="runQuickQuery('pending-payments')">Pending Payments</button><button class="btn btn-sm btn-info" onclick="runQuickQuery('total-revenue')">Total Revenue</button><button class="btn btn-sm btn-info" onclick="runQuickQuery('medication-ready')">Medication Ready</button></div></div></div>`;
}

function executeQuery(){
const query=document.getElementById('queryInput').value.trim();
const resultDiv=document.getElementById('queryResult');
if(!query){
resultDiv.innerHTML='<div class="query-result"><p style="color:var(--danger);">Please enter a query</p></div>';
return;
}
try{
const result=eval(query);
resultDiv.innerHTML=`<div class="query-result"><h4 style="color:var(--success);margin-bottom:15px;"><i class="fas fa-check-circle"></i> Query Result</h4><div class="json-viewer"><pre>${JSON.stringify(result,null,2)}</pre></div><p style="margin-top:15px;color:var(--text-secondary);"><strong>Type:</strong> ${typeof result} | <strong>Length:</strong> ${Array.isArray(result)?result.length:'N/A'}</p></div>`;
}catch(error){
resultDiv.innerHTML=`<div class="query-result"><h4 style="color:var(--danger);margin-bottom:15px;"><i class="fas fa-exclamation-circle"></i> Query Error</h4><p style="color:var(--danger);">${error.message}</p></div>`;
}
}

function clearQueryResult(){
document.getElementById('queryInput').value='';
document.getElementById('queryResult').innerHTML='';
}

function runQuickQuery(type){
const queries={
'patients':'patients',
'appointments':'appointments',
'scheduled':'appointments.filter(a => a.status === "scheduled")',
'pending-payments':'appointments.filter(a => a.status === "exam-done")',
'total-revenue':'payments.reduce((sum, p) => sum + p.amount, 0)',
'medication-ready':'appointments.filter(a => a.status === "medication-ready")'
};
document.getElementById('queryInput').value=queries[type];
executeQuery();
}

function generateStatistics(){
const totalPatients=patients.length;
const totalAppointments=appointments.length;
const totalPayments=payments.length;
const totalRevenue=payments.reduce((sum,p)=>sum+p.amount,0);
const totalPrescriptions=prescriptions.length;
const totalDispensed=dispensed.length;
const totalArchives=archives.length;
const totalMessages=messages.length;
const totalTransactions=transactions.length;
const scheduledAppts=appointments.filter(a=>a.status==='scheduled').length;
const checkedInAppts=appointments.filter(a=>a.status==='checked-in').length;
const vitalsDoneAppts=appointments.filter(a=>a.status==='vitals-done').length;
const examDoneAppts=appointments.filter(a=>a.status==='exam-done').length;
const paymentDoneAppts=appointments.filter(a=>a.status==='payment-done').length;
const medicationReadyAppts=appointments.filter(a=>a.status==='medication-ready').length;
const pendingPrescriptions=prescriptions.filter(p=>p.status==='pending').length;
const dispensedPrescriptions=prescriptions.filter(p=>p.status==='dispensed').length;
const unreadMessages=messages.filter(m=>!m.read).length;
return`<div style="padding:20px;"><h3 style="color:var(--primary);margin-bottom:20px;"><i class="fas fa-chart-bar"></i> Database Statistics</h3><h4 style="color:var(--text-primary);margin:30px 0 15px 0;">General Statistics</h4><div class="stat-grid"><div class="stat-box"><h3>${totalPatients}</h3><p>Total Patients</p></div><div class="stat-box"><h3>${totalAppointments}</h3><p>Total Appointments</p></div><div class="stat-box"><h3>${totalPayments}</h3><p>Total Payments</p></div><div class="stat-box"><h3>$${totalRevenue.toFixed(2)}</h3><p>Total Revenue</p></div><div class="stat-box"><h3>${totalPrescriptions}</h3><p>Total Prescriptions</p></div><div class="stat-box"><h3>${totalDispensed}</h3><p>Medications Dispensed</p></div><div class="stat-box"><h3>${totalArchives}</h3><p>Archived Records</p></div><div class="stat-box"><h3>${totalMessages}</h3><p>Total Messages</p></div></div><h4 style="color:var(--text-primary);margin:30px 0 15px 0;">Appointment Status Breakdown</h4><div class="stat-grid"><div class="stat-box"><h3>${scheduledAppts}</h3><p>Scheduled</p></div><div class="stat-box"><h3>${checkedInAppts}</h3><p>Checked-In</p></div><div class="stat-box"><h3>${vitalsDoneAppts}</h3><p>Vitals Done</p></div><div class="stat-box"><h3>${examDoneAppts}</h3><p>Exam Done</p></div><div class="stat-box"><h3>${paymentDoneAppts}</h3><p>Payment Done</p></div><div class="stat-box"><h3>${medicationReadyAppts}</h3><p>Medication Ready</p></div></div><h4 style="color:var(--text-primary);margin:30px 0 15px 0;">Prescription Status</h4><div class="stat-grid"><div class="stat-box"><h3>${pendingPrescriptions}</h3><p>Pending</p></div><div class="stat-box"><h3>${dispensedPrescriptions}</h3><p>Dispensed</p></div></div><h4 style="color:var(--text-primary);margin:30px 0 15px 0;">Storage Information</h4><div class="stat-grid"><div class="stat-box"><h3>${Object.keys(localStorage).length}</h3><p>localStorage Keys</p></div><div class="stat-box"><h3>${(JSON.stringify(localStorage).length/1024).toFixed(2)} KB</h3><p>Total Storage Used</p></div><div class="stat-box"><h3>${unreadMessages}</h3><p>Unread Messages</p></div><div class="stat-box"><h3>${totalTransactions}</h3><p>Total Transactions</p></div></div></div>`;
}
</script>
</body>
</html>